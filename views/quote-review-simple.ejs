<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quote Review - <%= quoteData.projectName %></title>
  <style nonce="<%= locals.cspNonce %>">
    :root {
      --cream:#FFF9F0;
      --gold:#E3FF33;
      --pink:#F7D8EA;
      --ink:#111111;
      --text:#333333;
      --muted:#666666;
      --stroke:#E2DFDA;
      --bg:#FAF9F7;
    }

    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .page{display:grid;place-items:start center;padding:32px}
    .card{width:min(920px,96vw);background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.07);overflow:hidden;border:1px solid #eee}

    .card__header{background:var(--cream);padding:20px 24px 10px;border-bottom:1px solid var(--stroke)}
    .logo{height:40px;width:auto}
    .title{margin:10px 0 0;font-size:26px;font-weight:800;color:var(--ink)}
    .title .tag{background:transparent;border:none;border-radius:0;padding:0}

    .meta{padding:18px 24px;border-bottom:1px solid var(--stroke)}
    .meta .row{display:flex;gap:24px;align-items:center;margin:6px 0;flex-wrap:wrap}
    .meta span{color:var(--muted);margin-right:6px}
    .meta .token{background:var(--cream);border:1px solid var(--stroke);border-radius:6px;padding:2px 6px;font-style:normal;color:var(--ink)}
    .meta .stretch{flex:1 1 auto}

    .quote{padding:16px 24px}
    .quote h3{margin:0 0 10px;font-size:14px;font-weight:700;color:var(--ink)}
    .quote .quotebox{border:2px solid var(--stroke);border-radius:12px;overflow:hidden;background:#fff;padding:20px}
    .quote-details{margin:16px 0;line-height:1.6}
    .quote-item{padding:12px 0;border-bottom:1px solid #f0f0f0;display:grid;grid-template-columns:auto 1fr auto auto auto auto;gap:12px;align-items:center}
    .quote-item:last-child{border-bottom:2px solid var(--stroke);margin-bottom:12px}
    .quote-item .checkbox{width:18px;height:18px;accent-color:var(--gold)}
    .quote-item .description{font-weight:500}
    .quote-item .case-size{color:var(--muted);font-size:12px;margin-top:2px}
    .quote-item .price-info{display:flex;flex-direction:column;align-items:flex-end;min-width:100px}
    .quote-item .unit-price{color:var(--muted);font-size:14px}
    .quote-item .per-piece{color:var(--text);font-size:12px;font-weight:500}
    .quote-item .starts-at{color:var(--gold);font-size:12px;font-weight:600;background:var(--ink);padding:2px 6px;border-radius:4px;display:inline-block;margin-top:4px}
    .quote-item .qty-select{width:80px;height:32px;border:1px solid var(--stroke);border-radius:6px;padding:0 8px;text-align:center}
    .quote-item .qty-info{display:flex;align-items:center;gap:8px}
    .quote-item .qty-breakdown-btn{background:none;border:1px solid var(--stroke);color:var(--text);padding:0 8px;border-radius:4px;font-size:11px;cursor:pointer;white-space:nowrap;height:32px;display:flex;align-items:center;justify-content:center}
    .quote-item .qty-breakdown-btn:hover{background:var(--cream)}
    .quote-item .line-total{font-weight:600;min-width:80px;text-align:right}
    .quote-item.disabled{opacity:0.5}
    .quote-item.disabled .qty-select{background:#f5f5f5;color:#999}
    
    .quote-summary{margin-top:16px;padding:16px;background:var(--cream);border-radius:8px;border:1px solid var(--stroke)}
    .summary-line{display:flex;justify-content:space-between;margin:4px 0;padding:2px 0}
    .summary-line.total{font-weight:bold;font-size:18px;color:var(--ink);border-top:1px solid var(--stroke);margin-top:8px;padding-top:8px}
    .summary-line.deposit{color:var(--ink);font-weight:600}

    .form{padding:8px 24px 24px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .label{display:block;font-size:14px;font-weight:700;color:var(--ink);margin:6px 0}
    .check{display:flex;align-items:center;gap:8px;margin:6px 0}
    .check input{width:16px;height:16px;accent-color:var(--gold)}

    .disclaimer{font-size:13px;color:var(--muted);margin:12px 0;max-width:420px}
    .quote-terms{margin-top:20px;padding-top:16px;border-top:1px solid var(--stroke);font-size:14px;color:var(--muted)}
    .loading{display:none;text-align:center;padding:12px}
    .result{display:none;margin-top:12px;padding:12px;border-radius:5px}

    textarea{
      width:100%;min-height:120px;border:2px solid var(--stroke);border-radius:10px;padding:10px;resize:vertical;font:inherit
    }
    textarea:focus, .mini input:focus { outline:none;border-color:var(--gold); }

    .sigrow{display:grid;grid-template-columns:1fr 220px 1fr;gap:24px;margin-top:18px;align-items:start}
    .sigrow .mini{display:flex;flex-direction:column;justify-content:flex-start;align-items:flex-start}
    .sig canvas{width:100%;height:150px;border:2px solid var(--stroke);border-radius:12px;background:#fff;display:block}
    .sig .link{margin-top:8px;background:none;border:0;color:#000;cursor:pointer;padding:0;font-weight:600}

    .mini input[type="date"], .mini input[type="text"]{
      width:100%;height:40px;border:2px solid var(--stroke);border-radius:10px;padding:0 10px;font:inherit
    }

    .card .btn {
      background: var(--gold);
      color: #000;
      border: 0;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 800;
      line-height: 1.2;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 14px;
      text-decoration: none;
      height: 40px;
      min-width: 140px;
      box-sizing: border-box;
    }
    .card .btn.secondary { background: var(--muted); }
    .card .btn:hover { filter: brightness(.95); }

    .actions {
      padding: 24px;
    }
    .actions__row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    .card__footer{height:36px;background:var(--pink)}

    .loading.show { display: block; }
    .result.success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .result.error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }

    @media (max-width: 768px) {
      .page { padding: 16px; }
      .grid { grid-template-columns: 1fr; }
      .sigrow { grid-template-columns: 1fr; gap: 16px; }
      .quote, .form { padding: 16px 20px; }
      .actions { padding: 16px 20px 24px; }
    }
  </style>
</head>
<body class="page">
  <div class="card">
    <header class="card__header">
      <img src="/assets/logo.png" alt="SHUREPRINT" class="logo">
      <h1 class="title">Quote Review â€“ <span class="tag"><%= quoteData.projectName %></span></h1>
    </header>

    <section class="meta">
      <div class="row">
        <span>Quote #:</span>
        <em class="token"><%= quoteData.quoteNumber %></em>
        <span>Version:</span>
        <em class="token"><%= quoteData.quoteVersion %></em>
        <span class="stretch">Date Sent:</span>
        <em class="token"><%= quoteData.dateSent %></em>
      </div>
      <div class="row">
        <span>Sales Rep:</span>
        <em class="token"><%= quoteData.salesRepFirst %> <%= quoteData.salesRepLast %></em>
        <span>Valid Until:</span>
        <em class="token"><%= quoteData.validUntil %></em>
        <span class="stretch">Client Company:</span>
        <em class="token"><%= quoteData.clientCompany %></em>
      </div>
    </section>

    <section class="quote">
      <h3>QUOTE DETAILS</h3>
      <div class="quotebox">
        <div class="quote-details">
          <div class="quote-item" data-item="setup" data-unit-price="150">
            <input type="checkbox" class="checkbox" checked>
            <div class="description">
              <div>Project Setup & Design</div>
              <div class="unit-price">One-time setup fee</div>
              <div class="case-size">Case Size: 1 setup</div>
            </div>
            <div class="price-info">
              <div class="unit-price">$150.00</div>
              <div class="per-piece">$150.000/pc</div>
            </div>
            <div class="qty-info">
              <select class="qty-select">
                <option value="1" selected>1</option>
              </select>
            </div>
            <div class="line-total">$150.00</div>
          </div>
          
          <div class="quote-item" data-item="business-cards" data-unit-price="89">
            <input type="checkbox" class="checkbox" checked>
            <div class="description">
              <div>Business Cards - Premium</div>
              <div class="unit-price">Volume pricing available</div>
              <div class="case-size">Case Size: 1,000 cards per unit</div>
              <div class="starts-at">Starts at $65.00</div>
            </div>
            <div class="price-info">
              <div class="unit-price">$89.00</div>
              <div class="per-piece">$0.089/pc</div>
            </div>
            <div class="qty-info">
              <select class="qty-select">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
              </select>
              <button type="button" class="qty-breakdown-btn" onclick="alert('Quantity breakdown feature coming soon!')">
                Qty Breaks
              </button>
            </div>
            <div class="line-total">$89.00</div>
          </div>
          
          <div class="quote-item" data-item="letterhead" data-unit-price="45">
            <input type="checkbox" class="checkbox">
            <div class="description">
              <div>Letterhead - Premium</div>
              <div class="unit-price">Volume discounts apply</div>
              <div class="case-size">Case Size: 500 sheets per unit</div>
              <div class="starts-at">Starts at $30.00</div>
            </div>
            <div class="price-info">
              <div class="unit-price">$45.00</div>
              <div class="per-piece">$0.090/pc</div>
            </div>
            <div class="qty-info">
              <select class="qty-select">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
              </select>
              <button type="button" class="qty-breakdown-btn" onclick="alert('Quantity breakdown feature coming soon!')">
                Qty Breaks
              </button>
            </div>
            <div class="line-total">$0.00</div>
          </div>

          <div class="quote-item" data-item="rush" data-unit-price="25">
            <input type="checkbox" class="checkbox">
            <div class="description">
              <div>Rush Processing</div>
              <div class="unit-price">2-day turnaround</div>
              <div class="case-size">Case Size: 1 rush service</div>
            </div>
            <div class="price-info">
              <div class="unit-price">$25.00</div>
              <div class="per-piece">$25.000/pc</div>
            </div>
            <div class="qty-info">
              <select class="qty-select">
                <option value="1" selected>1</option>
              </select>
            </div>
            <div class="line-total">$0.00</div>
          </div>
        </div>
        
        <div class="quote-summary">
          <div class="summary-line">
            <span>Subtotal:</span>
            <span id="subtotal">$239.00</span>
          </div>
          <div class="summary-line">
            <span>Tax (8.5%):</span>
            <span id="tax">$20.32</span>
          </div>
          <div class="summary-line total">
            <span>Total:</span>
            <span id="total">$259.32</span>
          </div>
          <div class="summary-line deposit">
            <span>Required Deposit (50%):</span>
            <span id="deposit">$129.66</span>
          </div>
        </div>
        
        <div class="quote-terms">
          <p><strong>Terms:</strong> 50% deposit required to begin work. Final payment due upon completion.</p>
          <p><strong>Timeline:</strong> 2-3 business days from approval and deposit receipt.</p>
        </div>
      </div>
    </section>

    <section class="form">
      <form id="quoteForm">
        <div class="form-section">
          <label class="label" for="comments">Special Instructions (Optional)</label>
          <textarea name="comments" id="comments" placeholder="Any special instructions for your order..."></textarea>
        </div>

        <div class="sigrow">
          <div class="sig">
            <label class="label">Digital Signature *</label>
            <canvas id="signatureCanvas" width="400" height="150"></canvas>
            <button type="button" id="clearSignature" class="link">Clear Signature</button>
          </div>
          <div class="mini">
            <label class="label" for="customerName">Name *</label>
            <input type="text" name="customerName" id="customerName" required placeholder="Full Name">
          </div>
          <div class="mini">
            <label class="label" for="date">Date</label>
            <input type="date" id="date" name="date" value="<%= new Date().toISOString().split('T')[0] %>">
          </div>
        </div>
      </form>
    </section>

    <section class="actions">
      <div class="actions__row">
        <button type="submit" form="quoteForm" class="btn" id="submitQuoteBtn">ACCEPT QUOTE & PROCEED TO PAYMENT</button>
        <a href="<%= pdfUrl %>" target="_blank" class="btn secondary">Download PDF</a>
      </div>
      <div class="loading">
        Processing your approval...
      </div>
      <div id="result" class="result"></div>
    </section>

    <footer class="card__footer"></footer>
  </div>

  <script nonce="<%= locals.cspNonce %>">
    // Simple pricing without complex JSON
    const quoteItems = {
      'setup': { unitPrice: 150.00, required: true },
      'business-cards': { unitPrice: 89.00, required: false },
      'letterhead': { unitPrice: 45.00, required: false },
      'rush': { unitPrice: 25.00, required: false }
    };

    const TAX_RATE = 0.085;
    const DEPOSIT_RATE = 0.50;

    function updatePricing() {
      let subtotal = 0;
      
      document.querySelectorAll('.quote-item').forEach(item => {
        const itemKey = item.getAttribute('data-item');
        const checkbox = item.querySelector('.checkbox');
        const qtySelect = item.querySelector('.qty-select');
        const lineTotalEl = item.querySelector('.line-total');
        
        if (checkbox.checked) {
          const qty = parseInt(qtySelect.value) || 0;
          const unitPrice = quoteItems[itemKey]?.unitPrice || 0;
          const lineTotal = unitPrice * qty;
          subtotal += lineTotal;
          lineTotalEl.textContent = '$' + lineTotal.toFixed(2);
          item.classList.remove('disabled');
          qtySelect.disabled = false;
        } else {
          lineTotalEl.textContent = '$0.00';
          item.classList.add('disabled');
          qtySelect.disabled = true;
        }
      });
      
      const tax = subtotal * TAX_RATE;
      const total = subtotal + tax;
      const deposit = total * DEPOSIT_RATE;
      
      document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('tax').textContent = '$' + tax.toFixed(2);
      document.getElementById('total').textContent = '$' + total.toFixed(2);
      document.getElementById('deposit').textContent = '$' + deposit.toFixed(2);
      
      return { subtotal, tax, total, deposit };
    }

    // Initialize pricing calculations
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.quote-item').forEach(item => {
        const itemKey = item.getAttribute('data-item');
        const checkbox = item.querySelector('.checkbox');
        const qtySelect = item.querySelector('.qty-select');
        
        if (quoteItems[itemKey]?.required) {
          checkbox.addEventListener('click', function(e) {
            if (!this.checked) {
              e.preventDefault();
              return false;
            }
          });
        }
        
        checkbox.addEventListener('change', updatePricing);
        qtySelect.addEventListener('change', updatePricing);
      });
      
      updatePricing();
    });

    // Form submission with payment delegation
    document.getElementById('quoteForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = {};
      for (let [key, value] of formData.entries()) data[key] = value;

      if (!data.customerName) {
        showResult('Please provide your name to continue.', 'error');
        return;
      }

      // Simple payment delegation prompt
      const delegatePayment = confirm(
        "PAYMENT OPTIONS\n\n" +
        "Do you need to delegate payment to someone else (like accounting or finance)?\n\n" +
        "YES - Delegate payment (enter email address)\n" +
        "NO - I'll pay myself\n\n" +
        "Click OK to delegate payment\n" +
        "Click Cancel to pay yourself"
      );
      
      if (delegatePayment) {
        const delegateEmail = prompt(
          "PAYMENT DELEGATION\n\n" +
          "Enter the email address of the person who should receive the payment request:\n\n" +
          "(They will receive payment instructions and reminders)"
        );
        
        if (delegateEmail && delegateEmail.includes('@')) {
          data.delegatePayment = true;
          data.paymentEmail = delegateEmail;
        } else if (delegateEmail !== null) {
          showResult('Please enter a valid email address.', 'error');
          return;
        } else {
          return;
        }
      } else {
        data.delegatePayment = false;
      }

      data.accepted = true;
      data.selectedItems = [];
      document.querySelectorAll('.quote-item').forEach(item => {
        const itemKey = item.getAttribute('data-item');
        const checkbox = item.querySelector('.checkbox');
        const qtySelect = item.querySelector('.qty-select');
        
        if (checkbox.checked) {
          const qty = parseInt(qtySelect.value) || 0;
          const unitPrice = quoteItems[itemKey]?.unitPrice || 0;
          data.selectedItems.push({
            item: itemKey,
            quantity: qty,
            unitPrice: unitPrice,
            lineTotal: unitPrice * qty
          });
        }
      });

      data.pricing = updatePricing();

      showResult('Quote submission test successful!\n\nPayment delegation: ' + (data.delegatePayment ? data.paymentEmail : 'Direct payment'), 'success');
    });

    function showResult(message, type) {
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = message;
      resultDiv.className = 'result ' + type;
      resultDiv.style.display = 'block';
    }

    // Signature canvas setup (simplified)
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    canvas.addEventListener('mousedown', (e) => {
      isDrawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!isDrawing) return;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
    });

    canvas.addEventListener('mouseup', () => {
      isDrawing = false;
    });

    document.getElementById('clearSignature').addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  </script>
</body>
</html>