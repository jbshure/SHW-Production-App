<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shureprint Quote Builder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #000000;
      --secondary-color: #ffffff;
      --accent-color: #e3fc02;
      --neon: #E3FF33;
      --text-primary: #000000;
      --text-secondary: #666;
      --text-light: #999;
      --border-color: #e0e0e0;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
      --background-light: #fff;
      --background-gray: #f8f9fa;
      --cream: #FFF9F0;
      --shadow-sm: 0 2px 4px rgba(0,0,0,.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,.15);
    }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; min-height: 100vh; color: var(--text-primary); line-height: 1.6; }
    .quote-builder { max-width: 1400px; margin: 20px auto; background: var(--background-light); border-radius: 8px; box-shadow: var(--shadow-sm); overflow: hidden; }
    /* Page Header */
    .page-header {
      background: var(--cream);
      padding: 20px 30px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    
    .page-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }
    
    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      transition: all 0.3s ease;
    }
    
    .nav-link:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .header { background: var(--background-light); color: var(--text-primary); padding: 40px; position: relative; overflow: hidden; border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
    .header::before { content: ''; position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: var(--accent-color); border-radius: 50%; opacity: .05; transform: translate(50px,-50px); }
    .header-content { position: relative; z-index: 2; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
    .brand-section { display: flex; align-items: center; gap: 20px; }
    .logo-container { height: 60px; background: transparent; display: flex; align-items: center; justify-content: center; padding: 0 10px; }
    .brand-text h1 { font-size: 2.5rem; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 4px; color: var(--text-primary); }
    .brand-text p { font-size: 1rem; opacity: .8; font-weight: 400; color: var(--text-secondary); }
    .quote-number { background: var(--accent-color); color: #000; padding: 12px 20px; border-radius: 25px; font-weight: 700; font-size: 1.1rem; font-family: 'Montserrat', sans-serif; }
    .status-indicator { position: absolute; top: 20px; right: 20px; background: var(--success-color); color: #fff; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: .9rem; box-shadow: var(--shadow-sm); }
    .progress-bar { background: rgba(255,255,255,.2); border-radius: 10px; overflow: hidden; margin-top: 20px; height: 6px; }
    .progress-fill { background: var(--accent-color); height: 100%; transition: width .3s ease; width: 0%; border-radius: 10px; }
    .main-grid { display: grid; grid-template-columns: 1fr 380px; gap: 0; min-height: 800px; }
    .quote-form-section { padding: 40px; overflow-y: auto; max-height: 800px; }
    .quote-preview { background: var(--background-gray); border-left: 1px solid var(--border-color); padding: 40px 30px; overflow-y: auto; max-height: 800px; }
    .form-section { background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px; padding: 30px; margin-bottom: 20px; transition: all .3s ease; position: relative; }
    .form-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--accent-color); transform: scaleX(0); transition: transform 0.3s ease; }
    .form-section:hover { box-shadow: var(--shadow-sm); border-color: var(--accent-color); }
    .form-section:hover::before { transform: scaleX(1); }
    .form-section h3 { color: var(--text-primary); margin-bottom: 24px; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 12px; }
    .section-icon { width: 28px; height: 28px; background: var(--accent-color); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #000; font-weight: 600; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full-width { grid-column: 1 / -1; }
    label { font-family: 'Inter', sans-serif; font-weight: 500; color: var(--text-primary); margin-bottom: 8px; font-size: .9rem; }
    input, textarea, select { padding: 14px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; transition: all .3s ease; font-family: inherit; background: var(--background-light); color: var(--text-primary); }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(227,252,2,.1); }
    .btn { padding: 14px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: .95rem; transition: all .3s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-family: inherit; }
    .btn-primary { background: var(--accent-color); color: #000; font-weight: 600; }
    .btn-primary:hover { background: #d4ed02; transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-accent { background: var(--accent-color); color: #000; font-weight: 600; }
    .btn-accent:hover { background: #d4ed02; transform: translateY(-1px); box-shadow: var(--shadow-md); }
    .btn-outline { background: transparent; color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-outline:hover { background: var(--background-gray); border-color: var(--accent-color); }
    .quick-templates { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap: 16px; margin: 24px 0; }
    .template-btn { background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px 16px; text-align: center; cursor: pointer; transition: all .3s ease; font-size: .9rem; color: var(--text-primary); }
    .template-btn:hover { border-color: var(--accent-color); background: var(--background-gray); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .items-table { width: 100%; border-collapse: collapse; margin: 24px 0; background: var(--background-light); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
    .items-table th { background: var(--primary-color); color: #fff; padding: 16px 12px; text-align: left; font-weight: 500; font-size: .9rem; }
    .items-table td { padding: 14px 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .items-table tbody tr:hover { background: var(--background-gray); }
    .items-table input, .items-table select { width: 100%; border: 1px solid var(--border-color); padding: 6px 8px; font-size: 12px; border-radius: 6px; background: var(--background-light); }
    .main-cost-field, .main-unitprice-field, .main-setupfee-field { min-width: 80px; }
    .items-table th:nth-child(3), .items-table td:nth-child(3) { width: 120px; } /* Quantity */
    .items-table th:nth-child(4), .items-table td:nth-child(4) { width: 90px; } /* Cost */
    .items-table th:nth-child(5), .items-table td:nth-child(5) { width: 70px; } /* Markup */
    .items-table th:nth-child(6), .items-table td:nth-child(6) { width: 90px; } /* Unit Price */
    .items-table th:nth-child(7), .items-table td:nth-child(7) { width: 90px; } /* Setup Fee */
    .items-table th:nth-child(8), .items-table td:nth-child(8) { width: 90px; } /* Total */
    .items-table th:nth-child(9), .items-table td:nth-child(9) { width: 90px; } /* Actions */
    .preview-section { background: var(--background-light); border-radius: 8px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border-color); transition: all .3s ease; position: relative; }
    .preview-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--accent-color); transform: scaleX(0); transition: transform 0.3s ease; }
    .preview-section:hover { box-shadow: var(--shadow-sm); }
    .preview-section:hover::before { transform: scaleX(1); }
    .preview-header { color: var(--text-primary); font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--accent-color); display: flex; align-items: center; gap: 8px; }
    .quote-summary { background: var(--primary-color); color: #fff; border-radius: 12px; padding: 24px; margin-bottom: 24px; }
    .summary-item { display: flex; justify-content: space-between; margin: 12px 0; padding: 8px 0; font-size: .95rem; }
    .summary-total { border-top: 1px solid rgba(255,255,255,.2); margin-top: 16px; padding-top: 16px; font-size: 1.25rem; font-weight: 600; }
    .actions-bar { display: flex; gap: 16px; margin-top: 40px; flex-wrap: wrap; justify-content: center; }
    .notification { position: fixed; top: 24px; right: 24px; background: var(--success-color); color: #fff; padding: 16px 24px; border-radius: 12px; font-weight: 500; z-index: 1000; transform: translateX(400px); transition: transform .3s ease; box-shadow: var(--shadow-lg); max-width: 350px; }
    .notification.show { transform: translateX(0); }
    .notification.error { background: var(--error-color); }
    .notification.warning { background: var(--warning-color); color: var(--text-primary); }
    .saved-indicator { color: var(--success-color); font-size: .85rem; margin-left: 12px; opacity: 0; transition: opacity .3s ease; font-weight: 500; }
    .saved-indicator.show { opacity: 1; }
    .floating-save-btn { position: fixed; bottom: 30px; right: 30px; background: var(--accent-color); color: #fff; border: none; border-radius: 50px; padding: 16px 24px; font-weight: 500; box-shadow: var(--shadow-lg); cursor: pointer; z-index: 100; transition: all .3s ease; font-family: inherit; }
    .floating-save-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(255,107,53,.4); }
    .ai-suggestions { background: linear-gradient(135deg,#fff5f2 0%,#fff 100%); border: 1px solid #ffd4c4; border-radius: 12px; padding: 20px; margin: 24px 0; }
    .ai-suggestions h4 { color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-weight: 600; }
    .suggestion-item { background: var(--background-light); border-radius: 8px; padding: 12px 16px; margin: 8px 0; border-left: 3px solid var(--accent-color); cursor: pointer; transition: all .2s; font-size: .9rem; color: var(--text-secondary); }
    .suggestion-item:hover { transform: translateX(4px); box-shadow: var(--shadow-sm); background: #fff5f2; }
    .brand-badge { background: var(--accent-color); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: .8rem; font-weight: 500; display: inline-block; margin-left: 8px; }
    @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } .quote-preview { border-left: none; border-top: 1px solid var(--border-color); } .header-content { flex-direction: column; text-align: center; } .form-row { grid-template-columns: 1fr; gap: 16px; } }
    @media (max-width: 768px) { .quote-builder { margin: 10px; border-radius: 12px; } .header { padding: 30px 20px; } .quote-form-section, .quote-preview { padding: 20px; } .brand-text h1 { font-size: 2rem; } .actions-bar { flex-direction: column; } .btn { justify-content: center; width: 100%; } }
    ::-webkit-scrollbar{ width:6px } ::-webkit-scrollbar-track{ background:var(--background-gray) } ::-webkit-scrollbar-thumb{ background:var(--border-color); border-radius:3px } ::-webkit-scrollbar-thumb:hover{ background:var(--text-light) }
  </style>
</head>
<body>
  <div class="quote-builder with-sidebar">
    <!-- Page Header -->
    <div class="page-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="page-title">Quote Builder</h1>
        <div id="emailStatus" style="display: flex; gap: 12px; align-items: center;">
          <div id="gmailNotConfigured" style="color: #28a745; font-size: 0.9rem;">Email Ready</div>
          <div id="gmailReady" style="color: #28a745; font-size: 0.9rem; display: none;">Gmail ready</div>
          <button id="connectGmail" onclick="handleAuthClick()" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem; display: none;">Connect Gmail</button>
        </div>
      </div>
    </div>
    
    <div class="header">
      <div class="status-indicator" id="statusIndicator">Draft</div>
      <div class="header-content">
        <div class="brand-section">
          <div class="quote-number" id="quoteNumber">QT-2025001</div>
        </div>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>

    <div class="main-grid">
      <div class="quote-form-section">
        <form id="quoteForm">
          <!-- Production Cards (single) -->
          <div class="form-section">
            <h3>Production Cards <span class="brand-badge">Trello Integration</span></h3>
            <div style="margin-bottom: 20px;">
              <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <select id="trelloListSelect" style="flex: 1;">
                  <option value="">Select a Trello list...</option>
                </select>
                <button type="button" onclick="testTrelloLoad()" class="btn btn-primary">Load Lists</button>
                <button type="button" onclick="testTrelloRefresh()" class="btn btn-primary">Load Cards</button>
              </div>
              <div id="trelloCardsList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; display: none;"></div>
            </div>
            <div id="selectedTrelloCards"></div>
            <div style="font-size: .9rem; color: var(--text-secondary); padding: 12px; background: var(--background-gray); border-radius: 8px;">üí° <strong>Tip:</strong> Select cards from Pre-Order Sales or Quoting to auto-populate quote items with existing project details.</div>
          </div>

          <!-- Client Information (single) -->
          <div class="form-section">
            <h3>Client Information <span class="saved-indicator" id="clientSaved">‚úì Saved</span></h3>
            <div class="form-row">
              <div class="form-group">
                <label for="clientCompany">Company Name *</label>
                <input type="text" id="clientCompany" name="clientCompany" required placeholder="Enter company name" onchange="updateProgress()" />
              </div>
              <div class="form-group">
                <label for="contactName">Contact Name *</label>
                <input type="text" id="contactName" name="contactName" required placeholder="Enter contact name" onchange="updateProgress()" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="contactEmail">Email Address *</label>
                <input type="email" id="contactEmail" name="contactEmail" required placeholder="contact@company.com" onchange="updateProgress()" />
              </div>
              <div class="form-group">
                <label for="contactPhone">Phone Number</label>
                <input type="tel" id="contactPhone" name="contactPhone" placeholder="(555) 123-4567" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="projectName">Project Name *</label>
                <input type="text" id="projectName" name="projectName" required placeholder="Describe the printing project" onchange="updateProgress()" />
              </div>
              <div class="form-group">
                <label for="quoteValidUntil">Quote Valid Until</label>
                <input type="date" id="quoteValidUntil" name="quoteValidUntil" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="salesRepName">Sales Rep Name</label>
                <input type="text" id="salesRepName" placeholder="Your name" onchange="updateProgress()" />
              </div>
              <div class="form-group">
                <label for="salesRepEmail">Sales Rep Email</label>
                <input type="email" id="salesRepEmail" placeholder="you@shurehw.com" onchange="updateProgress()" />
              </div>
            </div>
          </div>

          <!-- Product Catalog -->
          <div class="form-section">
            <h3>Product Catalog</h3>
            <div style="margin-bottom: 20px;">
              <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                <select id="productCategorySelect" style="flex: 1;" onchange="filterByCategory()">
                  <option value="">Categories loaded from Airtable</option>
                </select>
                <button type="button" onclick="testAirtableLoad()" class="btn btn-primary">Load Catalog</button>
                <button type="button" onclick="testAirtableConnection()" class="btn btn-outline">Debug</button>
                <button type="button" onclick="toggleProductModal()" class="btn btn-primary">Browse Products</button>
              </div>
              <div style="font-size: .9rem; color: var(--text-secondary); padding: 12px; background: var(--background-gray); border-radius: 8px;"><strong>Product Catalog:</strong> Products and categories will load from Airtable when API is configured.</div>
            </div>
          </div>

          <!-- Quote Items -->
          <div class="form-section">
            <h3>Quote Items <span class="saved-indicator" id="itemsSaved">‚úì Saved</span></h3>
            <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              <button type="button" onclick="addRow()" class="btn btn-primary">+ Add Item</button>
            </div>
            <table class="items-table" id="itemsTable">
              <thead>
                <tr>
                  <th>Product/Service</th>
                  <th>Specifications</th>
                  <th>Qty</th>
                  <th>Cost</th>
                  <th>Markup %</th>
                  <th>Unit Price</th>
                  <th>Setup Fee</th>
                  <th>Total</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <tr>
                  <td><input type="text" name="product[]" placeholder="Enter product name" onchange="updateProgress(); updateQuoteNumber();" /></td>
                  <td><input type="text" name="specs[]" placeholder="Size, material, colors, etc." onchange="updateQuoteNumber();" /></td>
                  <td>
                    <div style="display: flex; gap: 4px; align-items: center;">
                      <input type="number" name="quantity[]" value="1000" min="1" onchange="calculateRow(this)" style="flex: 1; min-width: 50px; width: 70px;" />
                      <button type="button" onclick="openQuantityModal(this)" class="btn" style="padding: 4px 8px; font-size: .7rem; background: var(--accent-color); color: #000;" title="Add quantity variations">+</button>
                    </div>
                  </td>
                  <td><input type="number" name="cost[]" step="0.001" placeholder="0.000" onchange="calculateRow(this)" class="main-cost-field" /></td>
                  <td><input type="number" name="markup[]" value="50" min="0" step="1" onchange="calculateRow(this)" class="main-markup-field" /></td>
                  <td><input type="number" name="unitPrice[]" step="0.001" placeholder="0.000" onchange="calculateRow(this)" class="main-unitprice-field" /></td>
                  <td><input type="number" name="setupFee[]" step="0.01" placeholder="0.00" onchange="calculateRow(this)" class="main-setupfee-field" /></td>
                  <td><input type="number" name="total[]" step="0.01" placeholder="0.00" readonly class="main-total-field" /></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button type="button" onclick="openItemDetailsModal(this)" class="btn" style="background: var(--accent-color); color: #000; padding: 6px 8px; font-size: .8rem;" title="Expand item details">‚äû</button>
                      <button type="button" onclick="removeRow(this)" class="btn" style="background: var(--error-color); color: #fff; padding: 6px 8px; font-size: .8rem;">√ó</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>


          <!-- Pricing & Terms -->
          <div class="form-section">
            <h3>Pricing & Terms</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="taxRate">Tax Rate (%)</label>
                <input type="number" id="taxRate" name="taxRate" value="9.5" step="0.01" onchange="calculateTotals()" />
                <small style="color: var(--text-light); font-size: .8rem;">LA County rate</small>
              </div>
              <div class="form-group">
                <label for="shippingCost">Shipping Cost ($)</label>
                <input type="number" id="shippingCost" name="shippingCost" value="0" step="0.01" min="0" onchange="calculateTotals()" />
                <small style="color: var(--text-light); font-size: .8rem;">Leave 0 for local pickup</small>
              </div>
              <div class="form-group">
                <label for="depositPercent">Required Deposit (%)</label>
                <input type="number" id="depositPercent" name="depositPercent" value="50" step="0.01" onchange="calculateTotals()" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="deliveryTime">Estimated Delivery</label>
                <select id="deliveryTime" name="deliveryTime">
                  <option value="3-5 business days">3-5 business days</option>
                  <option value="1-2 weeks" selected>1-2 weeks</option>
                  <option value="2-3 weeks">2-3 weeks</option>
                  <option value="3-4 weeks">3-4 weeks</option>
                  <option value="Custom timeline">Custom timeline</option>
                </select>
              </div>
              <div class="form-group">
                <label for="paymentTerms">Payment Terms</label>
                <select id="paymentTerms" name="paymentTerms">
                  <option value="50% deposit, balance on completion" selected>50% deposit, balance on completion</option>
                  <option value="Net 15">Net 15</option>
                  <option value="Net 30">Net 30</option>
                  <option value="Payment in full upfront">Payment in full upfront</option>
                </select>
              </div>
            </div>
            <div class="form-group full-width">
              <label for="specialInstructions">Special Instructions/Notes</label>
              <textarea id="specialInstructions" name="specialInstructions" placeholder="Any special requirements, deadlines, branding specifications, or notes for this project..." rows="3"></textarea>
            </div>
          </div>

          <div class="actions-bar">
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
              <div style="flex: 1; display: flex; gap: 10px;">
                <button type="button" onclick="sendToCustomer()" class="btn btn-accent">Send to Customer</button>
                <button type="button" onclick="showPaymentOptions('deposit')" class="btn btn-success" id="paymentBtn" style="display: none;">Collect Deposit</button>
                <button type="button" onclick="showPaymentOptions('final')" class="btn btn-success" id="finalPaymentBtn" style="display: none;">Collect Final Payment</button>
                <button type="button" onclick="previewQuote()" class="btn btn-primary">Preview</button>
              </div>
              <div style="display: flex; align-items: center; gap: 8px; background: var(--background-gray); padding: 8px 12px; border-radius: 8px;">
                <input type="checkbox" id="createTrelloCard" checked style="width: 18px; height: 18px;">
                <label for="createTrelloCard" style="margin: 0; font-size: 0.9rem; color: var(--text-secondary); cursor: pointer;">
                  üìã Create Trello Card with PDF
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="quote-preview">
        <div class="preview-section">
          <div class="preview-header">Items Breakdown</div>
          <div id="itemsPreview"><p style="color: var(--text-light); font-style: italic; text-align: center; padding: 24px;">Add items to see preview</p></div>
        </div>

        <div class="preview-section">
          <div class="preview-header">Project Timeline</div>
          <div id="timelinePreview">
            <div style="color: var(--text-secondary); margin: 12px 0; display: flex; justify-content: space-between;"><strong>Quote Valid Until:</strong><span id="validUntilPreview">Not set</span></div>
            <div style="color: var(--text-secondary); margin: 12px 0; display: flex; justify-content: space-between;"><strong>Estimated Delivery:</strong><span id="deliveryPreview">1-2 weeks</span></div>
            <div style="color: var(--text-secondary); margin: 12px 0; display: flex; justify-content: space-between;"><strong>Payment Terms:</strong><span id="paymentPreview">50% deposit, balance on completion</span></div>
          </div>
        </div>


        <div class="preview-section" style="background: linear-gradient(135deg,#fff5f2 0%,#fff 100%); border: 1px solid #ffd4c4;">
          <div class="preview-header" style="border-bottom-color: var(--accent-color);">Shureprint</div>
          <div style="font-size: .9rem; color: var(--text-secondary); line-height: 1.6;">
            <p>LA-based print and packaging company devoted to branding, hospitality, and design.</p>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ffd4c4; font-size: .8rem;"><strong>Specializing in:</strong> Custom packaging, paper products, hospitality branding</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="floating-save-btn" onclick="autoSave()" id="floatingSaveBtn">Auto-Save</button>
  <div id="notification" class="notification"></div>

  <!-- Item Details Modal -->
  <div id="itemDetailsModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1002; padding: 20px; box-sizing: border-box;">
    <div role="dialog" aria-modal="true" aria-labelledby="itemDetailsModalTitle" style="background: #fff; max-width: 900px; margin: 50px auto; border-radius: 16px; max-height: 90vh; overflow: hidden; box-shadow: var(--shadow-lg);">
      <div style="padding: 30px 30px 20px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
        <h2 id="itemDetailsModalTitle" style="margin: 0; color: var(--text-primary);">Item Details</h2>
        <button onclick="closeItemDetailsModal()" aria-label="Close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
      </div>
      <div style="padding: 30px; max-height: calc(90vh - 100px); overflow-y: auto;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Left Column -->
          <div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Product Name</label>
              <input type="text" id="modalProduct" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" onchange="updateItemFromModal()">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Specifications</label>
              <textarea id="modalSpecs" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; resize: vertical;" onchange="updateItemFromModal()"></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Additional Notes</label>
              <textarea id="modalNotes" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; resize: vertical;" placeholder="Internal notes (not shown to customer)" onchange="updateItemFromModal()"></textarea>
            </div>
          </div>
          
          <!-- Right Column -->
          <div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Quantity</label>
                <input type="number" id="modalQuantity" min="1" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" onchange="updateItemFromModal()">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Cost per Unit</label>
                <input type="number" id="modalCost" step="0.001" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" onchange="updateItemFromModal()">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Markup %</label>
                <input type="number" id="modalMarkup" min="0" step="1" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" onchange="updateItemFromModal()">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Unit Price</label>
                <input type="number" id="modalUnitPrice" step="0.001" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" onchange="updateItemFromModal()">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Setup Fee</label>
                <input type="number" id="modalSetupFee" step="0.01" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;" onchange="updateItemFromModal()">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Total</label>
                <input type="number" id="modalTotal" readonly style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--background-gray);">
              </div>
            </div>
            
            <!-- Quantity Variations Preview -->
            <div id="modalQuantityVariations" style="display: none; background: var(--background-gray); padding: 15px; border-radius: 8px; margin-top: 20px;">
              <h4 style="margin: 0 0 10px 0; color: var(--text-primary);">Quantity Variations</h4>
              <div id="modalVariationsList" style="font-size: 0.9rem; color: var(--text-secondary);"></div>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color);">
          <button type="button" onclick="closeItemDetailsModal()" class="btn btn-outline">Cancel</button>
          <button type="button" onclick="saveItemDetails()" class="btn btn-accent">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="productModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1000; padding: 20px; box-sizing: border-box;">
    <div role="dialog" aria-modal="true" aria-labelledby="productCatalogTitle" style="background: #fff; max-width: 800px; margin: 50px auto; border-radius: 16px; max-height: 80vh; overflow: hidden; box-shadow: var(--shadow-lg);">
      <div style="padding: 30px 30px 20px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
        <h2 id="productCatalogTitle" style="margin: 0; color: var(--text-primary);">Product Catalog</h2>
        <button onclick="toggleProductModal()" aria-label="Close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
      </div>
      <div style="padding: 20px 30px;">
        <input type="text" id="productSearch" placeholder="Search products..." style="width: 100%; margin-bottom: 20px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;" onkeyup="filterProducts()" />
        <div id="productCatalog" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- Quantity Variations Modal -->
  <div id="quantityModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5); z-index: 1001; padding: 20px; box-sizing: border-box;">
    <div role="dialog" aria-modal="true" aria-labelledby="quantityModalTitle" style="background: #fff; max-width: 700px; margin: 50px auto; border-radius: 16px; max-height: 80vh; overflow: hidden; box-shadow: var(--shadow-lg);">
      <div style="padding: 30px 30px 20px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
        <h2 id="quantityModalTitle" style="margin: 0; color: var(--text-primary);">Quantity Variations & Pricing</h2>
        <button onclick="closeQuantityModal()" aria-label="Close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">√ó</button>
      </div>
      <div style="padding: 20px 30px;">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Add different quantity options with their respective costs and markups for this item.</p>
        
        <table class="items-table" style="width: 100%; margin-bottom: 20px;">
          <thead>
            <tr>
              <th>Quantity</th>
              <th>Cost per Unit</th>
              <th>Markup %</th>
              <th>Unit Price</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="quantityVariationsBody">
            <!-- Variations will be added here -->
          </tbody>
        </table>
        
        <div style="display: flex; gap: 12px; justify-content: space-between;">
          <button type="button" onclick="addQuantityVariation()" class="btn btn-primary">+ Add Variation</button>
          <button type="button" onclick="saveQuantityVariations()" class="btn btn-accent">Save & Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="api-test.js"></script>
  <script src="api-integration.js"></script>
  <script>
    // Debug check immediately after loading
    console.log('üîç Script loading check:');
    console.log('- API_CONFIG:', !!window.API_CONFIG);
    console.log('- testFunction:', typeof window.testFunction);
    console.log('- loadTrelloLists:', typeof window.loadTrelloLists);
    console.log('- loadProductCatalogFromAirtable:', typeof window.loadProductCatalogFromAirtable);
  </script>
  <script>
    // Debug function to check environment variables
    window.debugAPIConfig = function() {
        console.log('üîç DEBUG: Checking API Configuration...');
        
        // Environment variables are loaded via config.js instead of import.meta.env
        console.log('‚ÑπÔ∏è Using config.js for API credentials instead of environment variables');
        
        console.log('‚ÑπÔ∏è To check your .env file manually, look for these variables:');
        console.log('- VITE_TRELLO_API_KEY');
        console.log('- VITE_TRELLO_TOKEN'); 
        console.log('- VITE_TRELLO_BOARD_ID');
        console.log('- VITE_AIRTABLE_API_KEY');
        console.log('- VITE_AIRTABLE_BASE_ID');
        
        // Check if functions exist
        console.log('Functions available:');
        console.log('- loadTrelloLists:', typeof window.loadTrelloLists);
        console.log('- loadProductCatalogFromAirtable:', typeof window.loadProductCatalogFromAirtable);
    };
    
    // Test Airtable connection with detailed debugging
    window.testAirtableConnection = async function() {
        console.log('üß™ Testing Airtable Connection...');
        showNotification('Testing Airtable API connection...', 'info');
        
        try {
            // This simulates what the actual function does but with more logging
            console.log('1. Checking if loadProductCatalogFromAirtable exists...');
            if (typeof window.loadProductCatalogFromAirtable !== 'function') {
                throw new Error('loadProductCatalogFromAirtable function not found');
            }
            
            console.log('2. Calling loadProductCatalogFromAirtable...');
            const result = await window.loadProductCatalogFromAirtable();
            
            console.log('3. Result:', result);
            if (result && result.length > 0) {
                console.log(`‚úÖ Success! Loaded ${result.length} products from Airtable`);
                showNotification(`‚úÖ Loaded ${result.length} products from Airtable!`, 'success');
            } else {
                console.log('‚ö†Ô∏è Function returned but no products loaded');
                showNotification('‚ö†Ô∏è No products loaded from Airtable', 'warning');
            }
        } catch (error) {
            console.error('‚ùå Airtable test failed:', error);
            showNotification(`‚ùå Airtable error: ${error.message}`, 'error');
        }
    };
    
    // Test functions that can be called from buttons
    window.testTrelloLoad = function() {
        console.log('üß™ Testing Trello load...');
        showNotification('Testing Trello connection...', 'info');
        
        if (typeof window.loadTrelloLists === 'function') {
            console.log('‚úÖ loadTrelloLists function found, calling it...');
            window.loadTrelloLists();
        } else {
            console.log('‚ùå loadTrelloLists function not found');
            showNotification('Trello functions not loaded. Check console for errors.', 'error');
        }
    };
    
    window.testAirtableLoad = function() {
        console.log('üß™ Testing Airtable load...');
        showNotification('Testing Airtable connection...', 'info');
        
        if (typeof window.loadProductCatalogFromAirtable === 'function') {
            console.log('‚úÖ loadProductCatalogFromAirtable function found, calling it...');
            window.loadProductCatalogFromAirtable();
        } else {
            console.log('‚ùå loadProductCatalogFromAirtable function not found');
            showNotification('Airtable functions not loaded. Check console for errors.', 'error');
        }
    };
    
    window.testTrelloRefresh = function() {
        console.log('üß™ Testing Trello card refresh...');
        const listId = document.getElementById('trelloListSelect').value;
        
        if (!listId) {
            showNotification('Please select a Trello list first', 'warning');
            console.log('‚ùå No list selected');
            return;
        }
        
        console.log('‚úÖ List selected:', listId);
        showNotification('Loading cards from selected list...', 'info');
        
        if (typeof window.refreshTrelloCards === 'function') {
            console.log('‚úÖ refreshTrelloCards function found, calling it...');
            window.refreshTrelloCards();
        } else {
            console.log('‚ùå refreshTrelloCards function not found');
            showNotification('Trello card functions not loaded. Check console for errors.', 'error');
        }
    };
    
    // ---------- Init state ----------
    let quoteCounter = 2025001;
    let autoSaveInterval; let isDirty = false;

    // Trello configuration (client only needs the board ID). Do NOT put keys/tokens here.
// Use the serverless proxy below. Set this to your real Trello board ID (safe to expose):
const TRELLO_BOARD_ID = '686da04ff3f765a86406b2c0';

    // Set initial quote number (will be updated when products are added)
    document.getElementById('quoteNumber').textContent = `QT-${Date.now()}`;

    // Default expiration date (+30 days)
    const expDate = new Date(); expDate.setDate(expDate.getDate() + 30);
    document.getElementById('quoteValidUntil').value = expDate.toISOString().split('T')[0];
    
    // Add test data button for quick testing
    window.fillTestData = function() {
        // Fill client info
        document.getElementById('clientCompany').value = 'Shure Hardware';
        document.getElementById('contactName').value = 'Jacob';
        document.getElementById('contactEmail').value = 'jacob@shurehw.com';
        document.getElementById('contactPhone').value = '(555) 123-4567';
        document.getElementById('projectName').value = 'Test Quote - Business Cards';
        
        // Add a sample item
        if (document.querySelector('input[name="product[]"]')) {
            document.querySelector('input[name="product[]"]').value = 'Premium Business Cards';
            document.querySelector('input[name="specs[]"]').value = '16pt, Matte Finish, Full Color';
            document.querySelector('input[name="quantity[]"]').value = '1000';
            document.querySelector('input[name="unitPrice[]"]').value = '0.15';
            document.querySelector('input[name="total[]"]').value = '150';
        }
        
        // Set shipping
        document.getElementById('shippingCost').value = '15';
        
        // Update preview
        updatePreview();
        calculateTotals();
        
        showNotification('Test data filled! Ready to send test quote.', 'success');
    };

    // Currency formatter
    // Simple email sending - let's use a working solution
    let emailServiceReady = false;
    
    // Initialize on page load
    window.addEventListener('load', function() {
        // Check if we can send emails
        updateEmailStatus();
    });
    
    function updateEmailStatus() {
        const notConfigured = document.getElementById('gmailNotConfigured');
        const ready = document.getElementById('gmailReady');
        const connectBtn = document.getElementById('connectGmail');
        
        // Show that email is ready via Firebase
        if (notConfigured) {
            notConfigured.textContent = 'Email Ready';
            notConfigured.style.color = '#28a745';
        }
        if (ready) ready.style.display = 'none';
        if (connectBtn) connectBtn.style.display = 'none';
    }
    
    // Simplified email sending function
    async function sendEmailDirectly(emailData) {
        // For now, we'll use the manual email approach
        // This ensures emails can always be sent
        console.log('Email data prepared for sending:', emailData);
        
        // You could integrate with EmailJS, SendGrid, or other services here
        // For now, return false to trigger manual send
        return false;
    }
    
    // Initialize EmailJS as backup
    (function() {
        // emailjs.init("YOUR_PUBLIC_KEY"); // Uncomment and add your key when ready
    })();
    
    const USD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

    // ---------- Product Catalog ----------
    // Products will be loaded from Airtable API - no hardcoded data
    let productCatalog = [];

    function initializeProductCatalog(){ 
      if (productCatalog.length === 0) {
        showNotification('Product catalog not loaded. Configure Airtable API first.', 'warning');
      }
      displayProducts(productCatalog); 
    }

    function toggleProductModal(){
      const modal = document.getElementById('productModal');
      const nowOpen = modal.style.display === 'block';
      modal.style.display = nowOpen ? 'none' : 'block';
      document.body.style.overflow = nowOpen ? 'auto' : 'hidden';
      if (!nowOpen) displayProducts(productCatalog);
    }

    function filterByCategory(){
      const selected = document.getElementById('productCategorySelect').value;
      if (productCatalog.length === 0) {
        showNotification('Product catalog not loaded. Configure Airtable API first.', 'warning');
        return;
      }
      if (!selected) return toggleProductModal(), displayProducts(productCatalog);
      const filtered = productCatalog.filter(p => p.category === selected);
      toggleProductModal(); displayProducts(filtered);
    }

    function displayProducts(products){
      const container = document.getElementById('productCatalog');
      if (!products.length){ container.innerHTML = '<div style="text-align:center;color:var(--text-light);padding:40px;">No products found.</div>'; return; }
      const grouped = products.reduce((acc, p)=>{ (acc[p.category] ||= []).push(p); return acc; }, {});
      let html = '';
      Object.keys(grouped).sort().forEach(category => {
        html += `<div style="margin-bottom:24px;"><h4 style="color:var(--text-primary); margin-bottom:12px; padding-bottom:6px; border-bottom:2px solid var(--accent-color); font-size:1.1rem;">${category}</h4>`;
        grouped[category].forEach(product => {
          const unavailableStyle = !product.available ? 'opacity:.6; text-decoration: line-through;' : '';
          const unavailableNote = !product.available ? `<span style="color: var(--error-color); font-size:.8rem; font-weight:500;"> (${product.note})</span>` : '';
          html += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; margin:6px 0; background:var(--background-light); border-radius:8px; border:1px solid var(--border-color); transition: all .2s; ${unavailableStyle}"
              onmouseover="this.style.borderColor='var(--accent-color)'; this.style.transform='translateY(-1px)'"
              onmouseout ="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'">
              <span style="color:var(--text-primary); font-weight:500;">${product.name}${unavailableNote}</span>
              <button onclick="addProductToQuoteAndClose('${product.name.replace(/'/g, "\\'")}', '${product.category}')" class="btn btn-primary" style="padding:8px 16px; font-size:.9rem;" ${!product.available ? 'disabled' : ''}>+ Add to Quote</button>
            </div>`;
        });
        html += '</div>';
      });
      container.innerHTML = html;
    }

    function filterProducts(){
      const term = document.getElementById('productSearch').value.toLowerCase();
      const filtered = productCatalog.filter(p => p.name.toLowerCase().includes(term) || p.category.toLowerCase().includes(term));
      displayProducts(filtered);
    }

    function createItemRow(){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" name="product[]" placeholder="Enter product name" onchange="updateProgress(); updateQuoteNumber();" /></td>
        <td><input type="text" name="specs[]" placeholder="Size, material, colors, etc." onchange="updateQuoteNumber();" /></td>
        <td>
          <div style="display: flex; gap: 4px; align-items: center;">
            <input type="number" name="quantity[]" value="1000" min="1" onchange="calculateRow(this)" style="flex: 1; min-width: 80px; width: 100px;" />
            <button type="button" onclick="openQuantityModal(this)" class="btn" style="padding: 4px 8px; font-size: .7rem; background: var(--accent-color); color: #000;" title="Add quantity variations">+</button>
          </div>
        </td>
        <td><input type="number" name="cost[]" step="0.001" placeholder="0.000" onchange="calculateRow(this)" class="main-cost-field" /></td>
        <td><input type="number" name="markup[]" value="50" min="0" step="1" onchange="calculateRow(this)" class="main-markup-field" /></td>
        <td><input type="number" name="unitPrice[]" step="0.001" placeholder="0.000" onchange="calculateRow(this)" class="main-unitprice-field" /></td>
        <td><input type="number" name="setupFee[]" step="0.01" placeholder="0.00" onchange="calculateRow(this)" class="main-setupfee-field" /></td>
        <td><input type="number" name="total[]" step="0.01" placeholder="0.00" readonly class="main-total-field" /></td>
        <td><button type="button" onclick="removeRow(this)" class="btn" style="background: var(--error-color); color: #fff; padding: 8px 12px; font-size: .8rem;">√ó</button></td>`;
      return tr;
    }

    function addProductToQuote(name, category){
      const body = document.getElementById('itemsTableBody');
      const firstRow = body.rows[0];
      const firstRowProduct = firstRow.querySelector('input[name="product[]"]').value;
      let row = (!firstRowProduct.trim()) ? firstRow : createItemRow();
      if (row !== firstRow) body.appendChild(row);
      row.querySelector('input[name="product[]"]').value = name;
      row.querySelector('input[name="specs[]"]').placeholder = `Enter specifications for ${name}`;
      let defaultQty = 1000; if (category==='Promotional') defaultQty=500; if (category==='Labels') defaultQty=5000; if (category==='Matches') defaultQty=2500;
      row.querySelector('input[name="quantity[]"]').value = defaultQty;
      updatePreview(); markDirty(); showNotification(`${name} added to quote!`);
    }
    function addProductToQuoteAndClose(name, category){ addProductToQuote(name, category); toggleProductModal(); }

    // Close modal when clicking outside
    document.addEventListener('click', (e)=>{ 
      const productModal = document.getElementById('productModal');
      const quantityModal = document.getElementById('quantityModal');
      const itemDetailsModal = document.getElementById('itemDetailsModal');
      if (e.target === productModal) toggleProductModal();
      if (e.target === quantityModal) closeQuantityModal();
      if (e.target === itemDetailsModal) closeItemDetailsModal();
    });
    // Close modal with ESC
    document.addEventListener('keydown', (e)=>{ 
      if (e.key==='Escape') {
        if (document.getElementById('itemDetailsModal').style.display==='block') closeItemDetailsModal();
        else if (document.getElementById('quantityModal').style.display==='block') closeQuantityModal();
        else if (document.getElementById('productModal').style.display==='block') toggleProductModal();
      }
    });

    function addRow(){
      const body = document.getElementById('itemsTableBody');
      const newRow = createItemRow();
      body.appendChild(newRow); markDirty(); updatePreview();
    }
    function removeRow(btn){
      const body = document.getElementById('itemsTableBody');
      if (body.rows.length > 1){ btn.closest('tr').remove(); calculateTotals(); updatePreview(); markDirty(); }
    }

    function calculateRow(input){
      const row = input.closest('tr');
      const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
      const cost = parseFloat(row.querySelector('input[name="cost[]"]').value) || 0;
      const markup = parseFloat(row.querySelector('input[name="markup[]"]').value) || 0;
      const setupFee = parseFloat(row.querySelector('input[name="setupFee[]"]').value) || 0;
      
      // Calculate unit price based on cost and markup
      let unitPrice = cost * (1 + markup / 100);
      
      // If unit price was manually changed, recalculate markup instead
      if (input.name === 'unitPrice[]') {
        unitPrice = parseFloat(row.querySelector('input[name="unitPrice[]"]').value) || 0;
        if (cost > 0) {
          const calculatedMarkup = ((unitPrice - cost) / cost) * 100;
          row.querySelector('input[name="markup[]"]').value = calculatedMarkup.toFixed(1);
        }
      } else {
        row.querySelector('input[name="unitPrice[]"]').value = unitPrice.toFixed(3);
      }
      
      const total = (unitPrice * quantity) + setupFee;
      row.querySelector('input[name="total[]"]').value = total.toFixed(2);
      calculateTotals(); updatePreview(); markDirty();
    }

    function calculateTotals(){
      const totals = document.querySelectorAll('input[name="total[]"]');
      let subtotal = 0; totals.forEach(i=> subtotal += parseFloat(i.value) || 0);
      const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
      const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
      const tax = subtotal * (taxRate/100); 
      const grand = subtotal + tax + shippingCost;
      const depositPercent = parseFloat(document.getElementById('depositPercent').value) || 0;
      const depositAmount = grand * (depositPercent/100);
      document.getElementById('previewTaxRate').textContent = taxRate.toFixed(2).replace(/\.00$/,'');
      document.getElementById('previewSubtotal').textContent = USD.format(subtotal);
      document.getElementById('previewShipping').textContent = USD.format(shippingCost);
      document.getElementById('previewTax').textContent = USD.format(tax);
      document.getElementById('previewTotal').textContent = USD.format(grand);
      document.getElementById('previewDeposit').textContent = USD.format(depositAmount);
    }

    function updateQuoteNumber() {
      const body = document.getElementById('itemsTableBody');
      if (body.rows.length > 0) {
        const firstRow = body.rows[0];
        const product = firstRow.querySelector('input[name="product[]"]').value;
        const specs = firstRow.querySelector('input[name="specs[]"]').value;
        
        if (product && product.trim()) {
          // Extract product code (like HONEYH-2141 or BOULEV-2116)
          // Assume product code is the first part before any dash followed by description
          let productCode = product.trim();
          let productDesc = '';
          
          // Check if product contains a product code pattern (LETTERS-NUMBERS)
          const codeMatch = productCode.match(/^([A-Z]+-\d+)(?:\s*-\s*(.*))?/);
          if (codeMatch) {
            productCode = codeMatch[1];
            productDesc = codeMatch[2] || specs?.split(',')[0]?.trim() || '';
          } else {
            // If no code pattern, use the full product name
            productDesc = specs?.split(',')[0]?.trim() || '';
          }
          
          // Create quote name
          let quoteName = productCode;
          if (productDesc) {
            quoteName = `${productCode} - ${productDesc}`;
          }
          
          document.getElementById('quoteNumber').textContent = quoteName;
          // Store the product code for PDF filename
          document.getElementById('quoteNumber').dataset.productCode = productCode;
        } else {
          // Default quote number if no product specified
          const defaultQuote = `QT-${Date.now()}`;
          document.getElementById('quoteNumber').textContent = defaultQuote;
          document.getElementById('quoteNumber').dataset.productCode = defaultQuote;
        }
      }
    }

    function updatePreview(){
      const body = document.getElementById('itemsTableBody');
      const itemsPreview = document.getElementById('itemsPreview');
      let html = '';
      
      // Update quote number based on first product
      updateQuoteNumber();
      
      for (let i=0;i<body.rows.length;i++){
        const row = body.rows[i];
        const product = row.querySelector('input[name="product[]"]').value;
        const specs = row.querySelector('input[name="specs[]"]').value;
        const quantityInput = row.querySelector('input[name="quantity[]"]');
        const quantity = quantityInput.value;
        const cost = row.querySelector('input[name="cost[]"]').value;
        const markup = row.querySelector('input[name="markup[]"]').value;
        const unitPrice = row.querySelector('input[name="unitPrice[]"]').value;
        const setupFee = row.querySelector('input[name="setupFee[]"]').value;
        const total = row.querySelector('input[name="total[]"]').value;
        
        // Check if this item has quantity variations
        const hasVariations = quantityInput.dataset.variations;
        let variations = [];
        if (hasVariations) {
          try {
            variations = JSON.parse(hasVariations);
          } catch (e) {
            variations = [];
          }
        }
        
        // Show all items, whether filled or empty
        const isEmpty = !product.trim();
        const itemClass = isEmpty ? 'background: var(--background-gray); border: 1px dashed var(--border-color);' : 'background: var(--background-light); border: 1px solid var(--border-color);';
        
        html += `
          <div style="padding: 12px; margin: 8px 0; border-radius: 8px; ${itemClass}">
            <div style="font-weight: 600; color: ${isEmpty ? 'var(--text-light)' : 'var(--text-primary)'};">
              ${product.trim() || `Item ${i + 1} - Not specified`}
            </div>
            ${specs ? `<div style="font-size: 0.9rem; color: var(--text-secondary); margin: 4px 0;">${specs}</div>` : 
              (isEmpty ? '<div style="font-size: 0.9rem; color: var(--text-light); font-style: italic;">No specifications added</div>' : '')}`;
        
        if (!isEmpty) {
          if (variations.length > 0) {
            // Show quantity variations
            html += `<div style="margin-top: 8px;">
              <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 6px; font-weight: 500;">Quantity Pricing Options:</div>`;
            
            variations.forEach(variation => {
              const csPrice = parseFloat(variation.total).toFixed(2);
              const unitPrice = parseFloat(variation.unitPrice).toFixed(3);
              html += `<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee;">
                <span style="color: var(--text-secondary);">${variation.quantity} units</span>
                <div style="text-align: right;">
                  <div style="font-weight: 600; font-size: 1rem;">$${csPrice}</div>
                  <div style="font-size: 0.85rem; color: var(--text-secondary);">$${unitPrice}/unit</div>
                </div>
              </div>`;
            });
            
            html += `</div>`;
          } else {
            // Show single pricing
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
              <span style="color: var(--text-secondary);">${quantity || '0'} units @ ${USD.format(parseFloat(unitPrice) || 0)}/unit</span>
              <span style="font-weight: 600;">${USD.format(parseFloat(total) || 0)}</span>
            </div>`;
            
            // Show markup info if cost is provided
            if (cost && parseFloat(cost) > 0) {
              html += `<div style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">Cost: ${USD.format(parseFloat(cost))}/unit ‚Ä¢ Markup: ${markup}%</div>`;
            }
            
            // Show setup fee if provided
            if (setupFee && parseFloat(setupFee) > 0) {
              html += `<div style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">Setup Fee: ${USD.format(parseFloat(setupFee))}</div>`;
            }
          }
        } else {
          // Show placeholder for empty items
          html += `<div style="color: var(--text-light); font-style: italic; margin-top: 8px;">
            <div>Quantity: ${quantity || '0'} units</div>
            <div>Total: ${USD.format(parseFloat(total) || 0)}</div>
          </div>`;
        }
        
        html += `</div>`;
      }
      itemsPreview.innerHTML = html || '<p style="color: var(--text-light); font-style: italic; text-align: center; padding: 24px;">Add items to see preview</p>';
      
      // Update timeline preview
      const validUntil = document.getElementById('quoteValidUntil').value;
      const delivery = document.getElementById('deliveryTime').value;
      const payment = document.getElementById('paymentTerms').value;
      
      document.getElementById('validUntilPreview').textContent = validUntil ? new Date(validUntil).toLocaleDateString() : 'Not set';
      document.getElementById('deliveryPreview').textContent = delivery;
      document.getElementById('paymentPreview').textContent = payment;
      
      calculateTotals();
    }
    
    function updateProgress(){
      const required = ['clientCompany', 'contactName', 'contactEmail', 'projectName'];
      const filled = required.filter(id => document.getElementById(id).value.trim());
      const hasItems = document.querySelector('input[name="product[]"]').value.trim();
      const progress = ((filled.length / required.length) * 70) + (hasItems ? 30 : 0);
      document.getElementById('progressFill').style.width = progress + '%';
      
      // Update payment button visibility based on quote completion
      updatePaymentButtons();
    }

    async function updatePaymentButtons() {
      const paymentBtn = document.getElementById('paymentBtn');
      const finalPaymentBtn = document.getElementById('finalPaymentBtn');
      
      if (!window.currentQuoteId) {
        paymentBtn.style.display = 'none';
        finalPaymentBtn.style.display = 'none';
        return;
      }
      
      try {
        const paymentStatus = await window.checkPaymentStatus();
        
        if (paymentStatus) {
          // Show deposit button if quote is accepted but no deposit paid
          if (paymentStatus.paymentStatus === 'payment_pending' && !paymentStatus.depositPaid) {
            paymentBtn.style.display = 'inline-flex';
            finalPaymentBtn.style.display = 'none';
          }
          // Show final payment button if deposit paid but not fully paid
          else if (paymentStatus.depositPaid && !paymentStatus.finalPaid) {
            paymentBtn.style.display = 'none';
            finalPaymentBtn.style.display = 'inline-flex';
          }
          // Hide both if fully paid
          else if (paymentStatus.finalPaid) {
            paymentBtn.style.display = 'none';
            finalPaymentBtn.style.display = 'none';
          }
          else {
            paymentBtn.style.display = 'none';
            finalPaymentBtn.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error updating payment buttons:', error);
        paymentBtn.style.display = 'none';
        finalPaymentBtn.style.display = 'none';
      }
    }
    
    function markDirty(){ isDirty = true; }
    
    function showNotification(message, type = 'success'){
      console.log(`Notification (${type}): ${message}`);
      const notification = document.getElementById('notification');
      if (notification) {
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        setTimeout(() => notification.classList.remove('show'), 3000);
      } else {
        console.warn('Notification element not found');
      }
    }
    
    // Auto-save functionality (disabled until Quotes table is set up)
    async function autoSave(){
      if (!isDirty) return;
      
      // Disable auto-save for now - no Quotes table in Airtable
      console.log('üíæ Auto-save disabled - Quotes table not available');
      return;
      
      try {
        // Save to Airtable
        await saveQuoteToAirtable();
        
        isDirty = false;
        const saveBtn = document.getElementById('floatingSaveBtn');
        saveBtn.style.background = 'var(--success-color)';
        saveBtn.innerHTML = '‚úÖ Saved';
        setTimeout(() => {
          saveBtn.innerHTML = 'Auto-Save';
          saveBtn.style.background = 'var(--accent-color)';
        }, 2000);
        // Don't show notification for auto-save to avoid spam
      } catch (error) {
        console.error('Auto-save failed:', error);
        // Silently fail for auto-save
      }
    }
    
    // Generate PDF as blob for attachments
    async function generateQuotePDFBlob(quoteData) {
        try {
            // Use jsPDF to create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add SHUREPRINT header
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('SHUREPRINT', 20, 25);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Quote', 20, 35);
            
            // Quote details
            let yPos = 50;
            doc.setFontSize(10);
            doc.text(`Quote Number: ${quoteData.quoteNumber}`, 20, yPos);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, yPos + 10);
            doc.text(`Valid Until: ${quoteData.validUntil || 'Not specified'}`, 20, yPos + 20);
            
            // Client info
            yPos += 40;
            doc.setFont(undefined, 'bold');
            doc.text('CLIENT INFORMATION', 20, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 10;
            doc.text(`Company: ${quoteData.clientCompany}`, 20, yPos);
            doc.text(`Contact: ${quoteData.contactName}`, 20, yPos + 10);
            doc.text(`Email: ${quoteData.contactEmail}`, 20, yPos + 20);
            if (quoteData.contactPhone) doc.text(`Phone: ${quoteData.contactPhone}`, 20, yPos + 30);
            
            // Items
            yPos += 50;
            doc.setFont(undefined, 'bold');
            doc.text('QUOTE ITEMS', 20, yPos);
            doc.setFont(undefined, 'normal');
            yPos += 15;
            
            quoteData.items.forEach((item, index) => {
                if (item.product && item.product.trim()) {
                    doc.text(`${index + 1}. ${item.product}`, 25, yPos);
                    if (item.specs) doc.text(`   ${item.specs}`, 25, yPos + 8);
                    doc.text(`   Qty: ${item.quantity} @ $${parseFloat(item.unitPrice || 0).toFixed(2)}/unit = $${parseFloat(item.total || 0).toFixed(2)}`, 25, yPos + 16);
                    yPos += 30;
                    
                    // Check if we need a new page
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                }
            });
            
            // Totals
            yPos += 10;
            doc.line(20, yPos, 190, yPos);
            yPos += 15;
            doc.text(`Subtotal: $${parseFloat(quoteData.subtotal || 0).toFixed(2)}`, 130, yPos);
            doc.text(`Shipping: $${parseFloat(quoteData.shipping || 0).toFixed(2)}`, 130, yPos + 10);
            doc.text(`Tax: $${parseFloat(quoteData.tax || 0).toFixed(2)}`, 130, yPos + 20);
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: $${parseFloat(quoteData.total || 0).toFixed(2)}`, 130, yPos + 35);
            
            // Convert to blob
            return doc.output('blob');
            
        } catch (error) {
            console.error('Error generating PDF blob:', error);
            return null;
        }
    }
    
    // Main action functions
    async function generatePDF(){
        try {
            showNotification('Generating PDF...', 'info');
            
            // Create a printable version of the quote
            const quoteData = collectQuoteData();
            
            // Create a new window with the quote content for printing
            const printWindow = window.open('', '_blank');
            const printContent = generatePrintableQuote(quoteData);
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Trigger print dialog
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                showNotification('‚úÖ PDF ready! Use browser print dialog to save as PDF', 'success');
                
                // Update quote status
                document.getElementById('statusIndicator').innerHTML = 'üìÑ PDF Ready';
                document.getElementById('statusIndicator').style.background = 'var(--success-color)';
            }, 500);
            
        } catch (error) {
            console.error('Error generating PDF:', error);
            showNotification(`PDF generation error: ${error.message}`, 'error');
            
            // Fallback - print current page
            if (confirm('PDF generation failed. Would you like to print the current page instead?')) {
                window.print();
            }
        }
    }
    
    // Helper function to collect quote data
    function collectQuoteData() {
        const items = [];
        const itemsTable = document.getElementById('itemsTableBody');
        
        for (let i = 0; i < itemsTable.rows.length; i++) {
            const row = itemsTable.rows[i];
            const product = row.querySelector('input[name="product[]"]').value;
            const specs = row.querySelector('input[name="specs[]"]').value;
            const quantity = row.querySelector('input[name="quantity[]"]').value;
            const unitPrice = row.querySelector('input[name="unitPrice[]"]').value;
            const total = row.querySelector('input[name="total[]"]').value;
            
            if (product.trim()) {
                items.push({
                    product,
                    specs,
                    quantity: parseInt(quantity) || 0,
                    unitPrice: parseFloat(unitPrice) || 0,
                    total: parseFloat(total) || 0
                });
            }
        }
        
        return {
            quoteNumber: document.getElementById('quoteNumber').textContent,
            clientCompany: document.getElementById('clientCompany').value,
            contactName: document.getElementById('contactName').value,
            contactEmail: document.getElementById('contactEmail').value,
            contactPhone: document.getElementById('contactPhone').value,
            projectName: document.getElementById('projectName').value,
            quoteValidUntil: document.getElementById('quoteValidUntil').value,
            salesRepName: document.getElementById('salesRepName').value,
            salesRepEmail: document.getElementById('salesRepEmail').value,
            deliveryTime: document.getElementById('deliveryTime').value,
            paymentTerms: document.getElementById('paymentTerms').value,
            specialInstructions: document.getElementById('specialInstructions').value,
            taxRate: document.getElementById('taxRate').value,
            subtotal: document.getElementById('previewSubtotal').textContent,
            shipping: document.getElementById('previewShipping').textContent,
            tax: document.getElementById('previewTax').textContent,
            total: document.getElementById('previewTotal').textContent,
            deposit: document.getElementById('previewDeposit').textContent,
            items: items
        };
    }
    
    // Helper function to generate printable HTML
    function generatePrintableQuote(data) {
        // Get logo base64 - use placeholder if not available
        const logoBase64 = '/9j/4AAQSkZJRgABAQEASABIAAD/2wBDAA...'; // This would be the actual base64
        
        return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Quote ${data.quoteNumber}</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: 'Segoe UI', Arial, sans-serif; 
                    padding: 30px; 
                    color: #333; 
                    background: white; 
                }
                
                /* Header with cream background */
                .header { 
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center; 
                    padding: 20px; 
                    background: #FFF9F0; 
                    border-radius: 8px;
                    border-bottom: 3px solid #E3FF33; 
                    margin-bottom: 20px; 
                }
                
                .logo-section {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }
                
                .company-name {
                    font-size: 28px;
                    font-weight: bold;
                    letter-spacing: 2px;
                }
                
                .quote-number { 
                    font-size: 13px; 
                    color: #666; 
                    margin-top: 5px; 
                }
                
                .quote-info { text-align: right; }
                .date-info { font-size: 12px; color: #666; line-height: 1.4; }
                
                /* Client section with cream background */
                .client-section { 
                    margin-bottom: 20px; 
                    background: #FFF9F0; 
                    padding: 15px; 
                    border-radius: 6px; 
                }
                
                .section { margin-bottom: 25px; }
                .section-title { 
                    font-size: 16px; 
                    font-weight: 600; 
                    margin-bottom: 10px; 
                    color: #000; 
                    border-bottom: 1px solid #ddd; 
                    padding-bottom: 5px; 
                }
                
                .client-grid { 
                    display: grid; 
                    grid-template-columns: repeat(4, 1fr); 
                    gap: 15px; 
                    font-size: 13px; 
                }
                
                .label { 
                    font-weight: 600; 
                    color: #666; 
                    font-size: 11px; 
                    text-transform: uppercase; 
                }
                
                .value { 
                    color: #000; 
                    font-size: 13px; 
                    margin-top: 2px; 
                }
                
                /* Quote table */
                .items-table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    background: white;
                }
                
                .items-table th { 
                    background: #000; 
                    color: #E3FF33; 
                    padding: 10px; 
                    text-align: left; 
                    font-weight: 600; 
                    font-size: 13px; 
                }
                
                .items-table td { 
                    padding: 10px; 
                    border-bottom: 1px solid #e0e0e0; 
                    font-size: 13px; 
                }
                
                .qty-details { line-height: 1.4; }
                .case-size { font-size: 11px; color: #666; }
                
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo-section">
                    <div class="company-name">SHUREPRINT</div>
                    <div class="quote-number">Quote: ${data.quoteNumber}</div>
                </div>
                <div class="quote-info">
                    <div class="date-info">
                        Date: ${new Date().toLocaleDateString()}<br>
                        Valid Until: ${data.quoteValidUntil ? new Date(data.quoteValidUntil).toLocaleDateString() : 'Not specified'}<br>
                        Quote #: ${data.quoteNumber}
                    </div>
                </div>
            </div>
            
            <div class="client-section">
                <div class="section-title">Client Information</div>
                <div class="client-grid">
                    <div>
                        <div class="label">Company</div>
                        <div class="value">${data.clientCompany}</div>
                    </div>
                    <div>
                        <div class="label">Contact</div>
                        <div class="value">${data.contactName}</div>
                    </div>
                    <div>
                        <div class="label">Phone</div>
                        <div class="value">${data.contactPhone}</div>
                    </div>
                    <div>
                        <div class="label">Email</div>
                        <div class="value">${data.contactEmail}</div>
                    </div>
                    <div>
                        <div class="label">Project</div>
                        <div class="value">${data.projectName}</div>
                    </div>
                    <div>
                        <div class="label">Sales Rep</div>
                        <div class="value">${data.salesRepName}</div>
                    </div>
                    <div>
                        <div class="label">Rep Email</div>
                        <div class="value">${data.salesRepEmail}</div>
                    </div>
                    <div>
                        <div class="label">Delivery</div>
                        <div class="value">${data.deliveryTime}</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Quote Details</div>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width: 20%">Product Code</th>
                            <th style="width: 40%">Description / Specifications</th>
                            <th style="width: 18%">CS Qty / Total</th>
                            <th style="width: 10%">Unit Price</th>
                            <th style="width: 12%">Line Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.items.map(item => {
                            // Calculate case quantity (assuming 50 pcs per case for demo)
                            const pcsPerCase = 50;
                            const cases = Math.ceil(item.quantity / pcsPerCase);
                            return `
                            <tr>
                                <td><strong>${item.product.split(' ')[0]}</strong></td>
                                <td>${item.product}<br><span style="font-size: 12px; color: #666;">${item.specs}</span></td>
                                <td>
                                    <div class="qty-details">
                                        <strong>${cases} CS</strong> (${item.quantity.toLocaleString()} units)<br>
                                        <span class="case-size">${pcsPerCase} pcs/case</span>
                                    </div>
                                </td>
                                <td>$${item.unitPrice.toFixed(2)}</td>
                                <td><strong>$${item.total.toFixed(2)}</strong></td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">Terms & Conditions</div>
                <p><strong>Delivery Time:</strong> ${data.deliveryTime}</p>
                <p><strong>Payment Terms:</strong> ${data.paymentTerms}</p>
                ${data.specialInstructions ? `<p><strong>Special Instructions:</strong> ${data.specialInstructions}</p>` : ''}
                <p style="margin-top: 20px; font-size: 12px; color: #666;">
                    This quote is valid until the specified date. Prices are subject to change without notice. 
                    Final pricing may vary based on artwork complexity and production requirements.
                </p>
            </div>
        </body>
        </html>
        `;
    }
    
    async function sendToCustomer(){
        try {
            showNotification('Preparing quote and Trello card...', 'info');
            
            // Collect quote data
            const quoteData = collectQuoteData();
            
            // Validate required fields
            if (!quoteData.clientCompany || !quoteData.contactEmail || !quoteData.projectName) {
                throw new Error('Please fill in client company, contact email, and project name');
            }
            
            if (quoteData.items.length === 0) {
                throw new Error('Please add at least one item to the quote');
            }
            
            // Handle Trello card - either attach to existing or create new
            let trelloCardId = null;
            let trelloCardUrl = null;
            
            if (document.getElementById('createTrelloCard')?.checked !== false) {
                try {
                    // Check if a Trello card was already selected
                    if (window.selectedTrelloCard && window.selectedTrelloCard.id) {
                        // Attach quote PDF to existing selected card
                        showNotification('Attaching quote PDF to selected Trello card...', 'info');
                        
                        const attachResponse = await fetch(`/api/projects/${window.selectedTrelloCard.id}/attach-quote`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-Key': localStorage.getItem('apiKey') || 'sk-shureprint-api-2024'
                            },
                            body: JSON.stringify({
                                quoteData: {
                                    quoteNumber: quoteData.quoteNumber,
                                    projectName: quoteData.projectName,
                                    clientCompany: quoteData.clientCompany,
                                    customerName: quoteData.contactName || 'TBD',
                                    customerEmail: quoteData.contactEmail,
                                    customerPhone: quoteData.contactPhone || '',
                                    salesRepFirst: quoteData.salesRepName?.split(' ')[0] || 'Sales',
                                    salesRepLast: quoteData.salesRepName?.split(' ')[1] || 'Team',
                                    salesRepEmail: quoteData.salesRepEmail || 'sales@shureprint.com',
                                    dateSent: new Date().toLocaleDateString(),
                                    validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                                    projectDescription: quoteData.projectDescription || '',
                                    quoteItems: quoteData.items.map(item => ({
                                        name: item.product,
                                        quantity: item.quantity,
                                        price: parseFloat(item.price) || 0
                                    })),
                                    totalAmount: quoteData.total
                                }
                            })
                        });
                        
                        if (attachResponse.ok) {
                            const result = await attachResponse.json();
                            trelloCardId = window.selectedTrelloCard.id;
                            trelloCardUrl = window.selectedTrelloCard.url || `https://trello.com/c/${window.selectedTrelloCard.id}`;
                            showNotification('‚úÖ Quote PDF attached to Trello card!', 'success');
                        } else {
                            console.error('Failed to attach PDF to Trello card:', await attachResponse.text());
                            showNotification('‚ö†Ô∏è Could not attach PDF to card, continuing...', 'warning');
                        }
                    } else {
                        // No card selected - create a new one
                        showNotification('Creating new Trello card with quote PDF...', 'info');
                        
                        const trelloResponse = await fetch('/api/quotes/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-Key': localStorage.getItem('apiKey') || 'sk-shureprint-api-2024'
                            },
                            body: JSON.stringify({
                                quoteData: {
                                    quoteNumber: quoteData.quoteNumber,
                                    projectName: quoteData.projectName,
                                    clientCompany: quoteData.clientCompany,
                                    customerName: quoteData.contactName || 'TBD',
                                    customerEmail: quoteData.contactEmail,
                                    customerPhone: quoteData.contactPhone || '',
                                    salesRepFirst: quoteData.salesRepName?.split(' ')[0] || 'Sales',
                                    salesRepLast: quoteData.salesRepName?.split(' ')[1] || 'Team',
                                    salesRepEmail: quoteData.salesRepEmail || 'sales@shureprint.com',
                                    dateSent: new Date().toLocaleDateString(),
                                    validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                                    projectDescription: quoteData.projectDescription || '',
                                    quoteItems: quoteData.items.map(item => ({
                                        name: item.product,
                                        quantity: item.quantity,
                                        price: parseFloat(item.price) || 0
                                    })),
                                    totalAmount: quoteData.total
                                },
                                createTrelloCard: true,
                                attachPDF: true
                            })
                        });
                        
                        if (trelloResponse.ok) {
                            const result = await trelloResponse.json();
                            trelloCardId = result.trelloCardId;
                            trelloCardUrl = result.trelloCardUrl;
                            showNotification('‚úÖ New Trello card created with quote PDF!', 'success');
                        } else {
                            console.error('Failed to create Trello card:', await trelloResponse.text());
                            showNotification('‚ö†Ô∏è Could not create Trello card, continuing...', 'warning');
                        }
                    }
                } catch (trelloError) {
                    console.error('Error with Trello operation:', trelloError);
                    showNotification('‚ö†Ô∏è Trello operation failed, continuing with email...', 'warning');
                }
            }
            
            // No proof data needed
            
            // Generate customer portal URL with project data (including proof)
            const projectId = `proj_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
            const projectData = {
                id: projectId,
                quoteNumber: quoteData.quoteNumber,
                clientInfo: {
                    company: quoteData.clientCompany,
                    name: quoteData.contactName,
                    email: quoteData.contactEmail
                },
                projectName: quoteData.projectName,
                items: quoteData.items
            };
            
            // Create quote review URL with quote data
            const quoteViewerUrl = `https://shureprint-quote-builder.web.app/quote/review/builder?data=${encodeURIComponent(JSON.stringify(projectData))}`;
            
            // Prepare email data
            const emailData = {
                to: quoteData.contactEmail,
                customerName: quoteData.contactName,
                companyName: quoteData.clientCompany,
                projectName: quoteData.projectName,
                quoteNumber: quoteData.quoteNumber,
                totalAmount: quoteData.total,
                deliveryTime: quoteData.deliveryTime,
                salesRep: quoteData.salesRepName || 'Shureprint Team',
                salesEmail: quoteData.salesRepEmail || 'team@shureprint.com',
                portalUrl: quoteViewerUrl,
                items: quoteData.items
            };
            
            // Try to send via API first
            let emailSent = false;
            try {
                showNotification('Sending email via SMTP...', 'info');
                // Use localhost for development, Firebase Functions for production
                // Try multiple email endpoints for maximum reliability
                const emailEndpoints = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                    ? [
                        'http://127.0.0.1:5002/shureprint-quote-builder/us-central1/emailApi/send-quote-email',
                        'http://localhost:3001/api/send-quote-email'
                      ]
                    : [
                        'https://shureprint-email-api.vercel.app/api/send-quote-email',
                        'https://us-central1-shureprint-quote-builder.cloudfunctions.net/api/send-quote-email'
                      ];
                
                const apiResponse = await fetch(emailEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: emailData.to,
                        customerName: emailData.customerName,
                        projectName: emailData.projectName,
                        quoteNumber: emailData.quoteNumber,
                        totalAmount: emailData.totalAmount,
                        portalUrl: emailData.portalUrl,
                        deliveryTime: emailData.deliveryTime,
                        salesRep: emailData.salesRep,
                        salesEmail: emailData.salesEmail
                    })
                });
                
                const result = await apiResponse.json();
                if (result.success) {
                    emailSent = true;
                    
                    // Update Trello card with portal link if we have one (PDF already attached earlier)
                    if ((window.selectedTrelloCard && window.selectedTrelloCard.id) || trelloCardId) {
                        try {
                            const cardId = trelloCardId || window.selectedTrelloCard.id;
                            showNotification('Updating Trello card with portal link...', 'info');
                            
                            // Just update the card with portal link (PDF was already attached)
                            await updateTrelloCardWithPortalLink(
                                cardId, 
                                quoteViewerUrl, 
                                quoteData.quoteNumber
                            );
                            
                        } catch (trelloError) {
                            console.error('Trello update failed:', trelloError);
                            // Don't fail the whole process if Trello update fails
                        }
                    }
                    
                    showNotification('‚úÖ Email sent successfully via API!', 'success');
                } else {
                    console.log('API send failed:', result);
                    throw new Error(result.error || 'API send failed');
                }
            } catch (apiError) {
                console.error('API send error:', apiError);
                showNotification('API send failed, trying EmailJS...', 'warning');
                
                // Fallback to EmailJS
                emailSent = await sendEmailDirectly(emailData);
            }
            
            if (emailSent) {
                // Save quote to dashboard
                try {
                    const quoteRecord = {
                        quoteNumber: quoteData.quoteNumber,
                        projectName: quoteData.projectName,
                        customerName: quoteData.contactName || quoteData.clientCompany,
                        customerEmail: quoteData.contactEmail,
                        status: 'sent',
                        totalAmount: parseFloat(quoteData.total.replace(/[$,]/g, '')) || 0,
                        items: quoteData.items,
                        createdDate: new Date(),
                        lastActivity: new Date(),
                        sentDate: new Date(),
                        portalUrl: quoteViewerUrl,
                        deliveryTime: quoteData.deliveryTime,
                        salesRep: quoteData.salesRepName,
                        salesEmail: quoteData.salesRepEmail,
                        taxRate: quoteData.taxRate,
                        shipping: quoteData.shipping,
                        specialInstructions: quoteData.specialInstructions
                    };
                    
                    // Get existing quotes
                    let allQuotes = [];
                    const storedQuotes = localStorage.getItem('shureprint_quotes');
                    if (storedQuotes) {
                        allQuotes = JSON.parse(storedQuotes);
                    }
                    
                    // Add new quote
                    quoteRecord.id = `Q-${Date.now()}`;
                    allQuotes.unshift(quoteRecord);
                    
                    // Save to localStorage
                    localStorage.setItem('shureprint_quotes', JSON.stringify(allQuotes));
                    console.log('Quote saved to dashboard:', quoteRecord);
                } catch (saveError) {
                    console.error('Failed to save quote to dashboard:', saveError);
                }
                
                // Email sent successfully
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 2000; padding: 20px;
                    display: flex; align-items: center; justify-content: center;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; max-width: 500px; width: 100%; border-radius: 16px; padding: 30px; text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚úÖ</div>
                        <h2 style="color: var(--success-color); margin-bottom: 15px;">Quote Sent Successfully!</h2>
                        <p style="margin-bottom: 20px;">The quote has been emailed to <strong>${emailData.to}</strong></p>
                        <p style="margin-bottom: 25px; color: var(--text-secondary);">
                            Quote Number: <strong>${emailData.quoteNumber}</strong><br>
                            Total: <strong>${emailData.totalAmount}</strong>
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <a href="${emailData.portalUrl}" target="_blank" class="btn btn-accent">View Quote</a>
                            <a href="/quotes-dashboard.html" class="btn btn-primary">View Dashboard</a>
                            <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn btn-outline">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                return;
            }
            
            // If neither API nor EmailJS worked, show manual send modal
            showEmailPreview(emailData);
            
        } catch (error) {
            console.error('Error sending to customer:', error);
            showNotification(`Error: ${error.message}`, 'error');
        }
    }
    
    async function sendEmailDirectly(emailData) {
        // Check if EmailJS is configured
        if (typeof emailjs !== 'undefined' && window.EMAILJS_SERVICE_ID && window.EMAILJS_TEMPLATE_ID) {
            try {
                const templateParams = {
                    to_email: emailData.to,
                    to_name: emailData.customerName,
                    from_name: 'Shureprint Team',
                    from_email: 'Quote@shureprint.com',
                    company_name: emailData.companyName,
                    project_name: emailData.projectName,
                    quote_number: emailData.quoteNumber,
                    total_amount: emailData.totalAmount,
                    delivery_time: emailData.deliveryTime || '1-2 weeks',
                    portal_url: emailData.portalUrl,
                    items_count: emailData.items ? emailData.items.length : 0,
                    message: `Thank you for choosing Shureprint for your ${emailData.projectName} project!`
                };
                
                const response = await emailjs.send(
                    window.EMAILJS_SERVICE_ID,
                    window.EMAILJS_TEMPLATE_ID,
                    templateParams
                );
                
                if (response.status === 200) {
                    showNotification('‚úÖ Email sent successfully to ' + emailData.to, 'success');
                    return true;
                }
            } catch (error) {
                console.error('EmailJS error:', error);
            }
        }
        return false;
    }
    
    function showEmailPreview(emailData) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 2000; padding: 20px; 
            display: flex; align-items: center; justify-content: center;
        `;
        
        modal.innerHTML = `
            <div style="background: white; max-width: 600px; width: 100%; border-radius: 16px; padding: 30px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Customer Email Preview</h2>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="margin-bottom: 15px;"><strong>To:</strong> ${emailData.to}</div>
                    <div style="margin-bottom: 15px;"><strong>Subject:</strong> Your Shureprint Quote ${emailData.quoteNumber} - Review & Approve</div>
                    
                    <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                        <p>Dear ${emailData.customerName},</p>
                        <p>Thank you for choosing Shureprint for your <strong>${emailData.projectName}</strong> project!</p>
                        <p>Your quote <strong>${emailData.quoteNumber}</strong> for <strong>${emailData.totalAmount}</strong> is ready for review.</p>
                        
                        <p><strong>Next Steps:</strong></p>
                        <ol>
                            <li>Click the link below to review your project details</li>
                            <li>Select your preferred quantity</li>
                            <li>Complete secure payment to begin production</li>
                        </ol>
                        
                        
                        <p><strong>Estimated Delivery:</strong> ${emailData.deliveryTime}</p>
                        <p>Questions? Reply to this email or contact ${emailData.salesRep} at ${emailData.salesEmail}</p>
                        
                        <p>Best regards,<br>The Shureprint Team</p>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="sendEmailNow('${emailData.to}', '${emailData.customerName}', '${emailData.projectName}', '${emailData.quoteNumber}', '${emailData.totalAmount}', '${emailData.portalUrl}', '${emailData.deliveryTime}', '${emailData.salesRep}', '${emailData.salesEmail}')" class="btn btn-accent" style="margin-right: 10px;">üìß Send Email Now</button>
                    <a href="${emailData.portalUrl}" target="_blank" class="btn btn-primary" style="margin-right: 10px;">üîó Open Quote</a>
                    <button onclick="copyPortalLink('${emailData.portalUrl}')" class="btn btn-outline">üìã Copy Link</button>
                </div>
                
                <div style="margin-top: 15px; padding: 15px; background: #e3fc02; border-radius: 8px; text-align: center; font-size: 0.9rem;">
                    <strong>üìß Email Ready:</strong> Click "Send Email Now" to send the quote instantly to your customer!
                </div>
            </div>
        `;
        
        modal.className = 'modal';
        document.body.appendChild(modal);
        
        showNotification('‚úÖ Customer email prepared! Portal link generated.', 'success');
    }
    
    function copyPortalLink(url) {
        navigator.clipboard.writeText(url).then(() => {
            showNotification('‚úÖ Portal link copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('‚úÖ Portal link copied to clipboard!', 'success');
        });
    }
    
    async function sendEmailNow(to, customerName, projectName, quoteNumber, totalAmount, portalUrl, deliveryTime, salesRep, salesEmail) {
        try {
            showNotification('Sending email via SMTP...', 'info');
            
            // Try to send via API first
            // Use localhost for development, Firebase Functions for production
            const emailEndpoint = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://127.0.0.1:5002/shureprint-quote-builder/us-central1/emailApi/send-quote-email' 
                : 'https://us-central1-shureprint-quote-builder.cloudfunctions.net/api/send-quote-email';
            
            const apiResponse = await fetch(emailEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    to: to,
                    customerName: customerName,
                    projectName: projectName,
                    quoteNumber: quoteNumber,
                    totalAmount: totalAmount,
                    portalUrl: portalUrl,
                    deliveryTime: deliveryTime,
                    salesRep: salesRep,
                    salesEmail: salesEmail
                })
            });
            
            const result = await apiResponse.json();
            if (result.success) {
                showNotification('‚úÖ Email sent successfully via SMTP!', 'success');
                // Close the modal
                const modal = document.querySelector('.modal');
                if (modal) modal.remove();
                return;
            } else {
                throw new Error(result.error || 'API send failed');
            }
            
        } catch (error) {
            console.error('Error sending email via API:', error);
            showNotification(`‚ùå SMTP send failed: ${error.message}. Opening Gmail as fallback...`, 'warning');
            
            // Fallback to Gmail compose
            const subject = `Your SHUREPRINT Quote ${quoteNumber} - Review & Approve`;
            const body = `Dear ${customerName},

Thank you for choosing SHUREPRINT for your ${projectName} project!

Quote Details:
‚Ä¢ Quote Number: ${quoteNumber}
‚Ä¢ Total Amount: ${totalAmount}
‚Ä¢ Estimated Delivery: ${deliveryTime || '1-2 weeks'}

Next Steps:
1. Review your quote details: ${portalUrl}
2. Select your preferred quantity  
3. Complete secure payment to begin production

Questions? Reply to this email or contact ${salesRep} at ${salesEmail}

Best regards,
The SHUREPRINT Team`;

            // Create Gmail compose URL
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open Gmail in new tab
            window.open(gmailUrl, '_blank');
            
            showNotification('‚úÖ Email opened in Gmail! Please review and send.', 'success');
        }
    }
    
    
    // Quantity Modal Functions
    function openQuantityModal(btn) {
      const modal = document.getElementById('quantityModal');
      const qtyInput = btn.parentElement.querySelector('input[name="quantity[]"]');
      const currentQty = qtyInput.value;
      
      // Clear existing variations
      const tbody = document.getElementById('quantityVariationsBody');
      tbody.innerHTML = '';
      
      // Check if this input has existing variations stored
      const existingVariations = qtyInput.dataset.variations;
      if (existingVariations) {
        try {
          const variations = JSON.parse(existingVariations);
          // Load existing variations
          variations.forEach(variation => {
            addQuantityVariation(
              variation.quantity,
              variation.cost,
              variation.markup,
              variation.unitPrice,
              variation.setupFee
            );
          });
        } catch (e) {
          console.error('Error parsing existing variations:', e);
          // Fallback to current quantity
          addQuantityVariation(currentQty, '');
        }
      } else {
        // Add current quantity as first variation
        addQuantityVariation(currentQty, '');
      }
      
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Store reference to the input field
      modal.dataset.targetInput = qtyInput.id || `qty_${Date.now()}`;
      if (!qtyInput.id) qtyInput.id = modal.dataset.targetInput;
    }
    
    function closeQuantityModal() {
      document.getElementById('quantityModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    // Item Details Modal Functions
    function openItemDetailsModal(btn) {
      const modal = document.getElementById('itemDetailsModal');
      const row = btn.closest('tr');
      
      // Store reference to the current row
      modal.dataset.currentRow = Array.from(row.parentNode.children).indexOf(row);
      
      // Populate modal with current values
      document.getElementById('modalProduct').value = row.querySelector('input[name="product[]"]').value || '';
      document.getElementById('modalSpecs').value = row.querySelector('input[name="specs[]"]').value || '';
      document.getElementById('modalQuantity').value = row.querySelector('input[name="quantity[]"]').value || '';
      document.getElementById('modalCost').value = row.querySelector('input[name="cost[]"]').value || '';
      document.getElementById('modalMarkup').value = row.querySelector('input[name="markup[]"]').value || '';
      document.getElementById('modalUnitPrice').value = row.querySelector('input[name="unitPrice[]"]').value || '';
      document.getElementById('modalSetupFee').value = row.querySelector('input[name="setupFee[]"]').value || '';
      document.getElementById('modalTotal').value = row.querySelector('input[name="total[]"]').value || '';
      
      // Store internal notes if they exist (using data attribute)
      const notes = row.dataset.notes || '';
      document.getElementById('modalNotes').value = notes;
      
      // Check if there are quantity variations
      const qtyInput = row.querySelector('input[name="quantity[]"]');
      if (qtyInput.dataset.variations) {
        const variations = JSON.parse(qtyInput.dataset.variations);
        document.getElementById('modalQuantityVariations').style.display = 'block';
        const variationsList = document.getElementById('modalVariationsList');
        variationsList.innerHTML = variations.map(v => 
          `<div>‚Ä¢ ${v.quantity} units @ $${v.unitPrice}/ea = $${v.total}</div>`
        ).join('');
      } else {
        document.getElementById('modalQuantityVariations').style.display = 'none';
      }
      
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeItemDetailsModal() {
      document.getElementById('itemDetailsModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateItemFromModal() {
      // Calculate totals in the modal
      const quantity = parseFloat(document.getElementById('modalQuantity').value) || 0;
      const cost = parseFloat(document.getElementById('modalCost').value) || 0;
      const markup = parseFloat(document.getElementById('modalMarkup').value) || 0;
      const setupFee = parseFloat(document.getElementById('modalSetupFee').value) || 0;
      
      // Calculate unit price based on cost and markup
      const unitPrice = cost * (1 + markup / 100);
      document.getElementById('modalUnitPrice').value = unitPrice.toFixed(3);
      
      // Calculate total
      const total = (unitPrice * quantity) + setupFee;
      document.getElementById('modalTotal').value = total.toFixed(2);
    }
    
    function saveItemDetails() {
      const modal = document.getElementById('itemDetailsModal');
      const rowIndex = parseInt(modal.dataset.currentRow);
      const tbody = document.getElementById('itemsTableBody');
      const row = tbody.rows[rowIndex];
      
      // Update row values
      row.querySelector('input[name="product[]"]').value = document.getElementById('modalProduct').value;
      row.querySelector('input[name="specs[]"]').value = document.getElementById('modalSpecs').value;
      row.querySelector('input[name="quantity[]"]').value = document.getElementById('modalQuantity').value;
      row.querySelector('input[name="cost[]"]').value = document.getElementById('modalCost').value;
      row.querySelector('input[name="markup[]"]').value = document.getElementById('modalMarkup').value;
      row.querySelector('input[name="unitPrice[]"]').value = document.getElementById('modalUnitPrice').value;
      row.querySelector('input[name="setupFee[]"]').value = document.getElementById('modalSetupFee').value;
      row.querySelector('input[name="total[]"]').value = document.getElementById('modalTotal').value;
      
      // Store internal notes
      row.dataset.notes = document.getElementById('modalNotes').value;
      
      // Recalculate totals
      calculateTotals();
      updatePreview();
      markDirty();
      
      closeItemDetailsModal();
      showNotification('Item details updated successfully');
    }
    
    function addQuantityVariation(qty = '', cost = '', markup = '50', unitPrice = '', setupFee = '') {
      const tbody = document.getElementById('quantityVariationsBody');
      const row = tbody.insertRow();
      
      // Calculate unit price if cost and markup are provided
      const calculatedUnitPrice = (cost && markup) ? (parseFloat(cost) * (1 + parseFloat(markup) / 100)).toFixed(3) : unitPrice;
      
      row.innerHTML = `
        <td><input type="number" value="${qty}" min="1" style="width: 100%; padding: 8px;" placeholder="1000" onchange="calculateVariationRow(this)"></td>
        <td><input type="number" step="0.001" value="${cost}" style="width: 100%; padding: 8px;" placeholder="0.000" onchange="calculateVariationRow(this)"></td>
        <td><input type="number" value="${markup}" min="0" step="1" style="width: 100%; padding: 8px;" placeholder="50" onchange="calculateVariationRow(this)"></td>
        <td><input type="number" step="0.001" value="${calculatedUnitPrice}" style="width: 100%; padding: 8px;" placeholder="0.000" readonly></td>
        <td><input type="number" step="0.01" value="" style="width: 100%; padding: 8px;" placeholder="0.00" readonly></td>
        <td><button type="button" onclick="this.parentElement.parentElement.remove()" style="background: var(--error-color); color: white; border: none; padding: 4px 8px; border-radius: 4px;">√ó</button></td>
      `;
      
      // Calculate the total for this row
      calculateVariationRow(row.cells[0].querySelector('input'));
    }
    
    function calculateVariationRow(input) {
      const row = input.closest('tr');
      if (!row) return;
      
      const qty = parseFloat(row.cells[0].querySelector('input').value) || 0;
      const cost = parseFloat(row.cells[1].querySelector('input').value) || 0;
      const markup = parseFloat(row.cells[2].querySelector('input').value) || 0;
      
      // Calculate unit price: cost + (cost * markup%)
      const unitPrice = cost * (1 + markup / 100);
      row.cells[3].querySelector('input').value = unitPrice.toFixed(3);
      
      // Calculate total: quantity * unit price
      const total = qty * unitPrice;
      row.cells[4].querySelector('input').value = total.toFixed(2);
    }
    
    function saveQuantityVariations() {
      const modal = document.getElementById('quantityModal');
      const targetInputId = modal.dataset.targetInput;
      const targetInput = document.getElementById(targetInputId);
      
      const variations = [];
      const rows = document.querySelectorAll('#quantityVariationsBody tr');
      rows.forEach(row => {
        const qty = row.cells[0].querySelector('input').value;
        const cost = row.cells[1].querySelector('input').value;
        const markup = row.cells[2].querySelector('input').value;
        const unitPrice = row.cells[3].querySelector('input').value;
        const total = row.cells[4].querySelector('input').value;
        
        if (qty) {
          variations.push({ 
            quantity: qty, 
            cost: cost,
            markup: markup,
            unitPrice: unitPrice,
            total: total
          });
        }
      });
      
      if (variations.length > 0) {
        // Use the first variation as the main quantity
        targetInput.value = variations[0].quantity;
        
        // Store variations in data attribute for later use
        targetInput.dataset.variations = JSON.stringify(variations);
        
        // Find the main row and disable the pricing fields
        const mainRow = targetInput.closest('tr');
        const costField = mainRow.querySelector('.main-cost-field');
        const markupField = mainRow.querySelector('.main-markup-field');
        const unitPriceField = mainRow.querySelector('.main-unitprice-field');
        const setupFeeField = mainRow.querySelector('.main-setupfee-field');
        const totalField = mainRow.querySelector('.main-total-field');
        
        // Disable and clear the main fields
        [costField, markupField, unitPriceField, setupFeeField].forEach(field => {
          if (field) {
            field.disabled = true;
            field.style.backgroundColor = '#f5f5f5';
            field.style.color = '#999';
            field.placeholder = 'Set in variations';
          }
        });
        
        // Set total from first variation
        if (totalField) {
          totalField.value = variations[0].total;
        }
        
        // Update overall calculations
        calculateTotals();
        updatePreview();
        
        showNotification(`Quantity variations saved (${variations.length} options)`);
      }
      
      closeQuantityModal();
    }
    
    // Preview Quote Function
    function previewQuote() {
      const form = document.getElementById('quoteForm');
      const formData = new FormData(form);
      
      // Collect all form data
      const quoteData = {
        client: {
          company: formData.get('clientCompany') || '',
          contact: formData.get('contactName') || '',
          email: formData.get('clientEmail') || '',
          phone: formData.get('clientPhone') || ''
        },
        items: [],
        totals: {
          subtotal: document.getElementById('previewSubtotal').textContent,
          shipping: document.getElementById('previewShipping').textContent,
          tax: document.getElementById('previewTax').textContent,
          total: document.getElementById('previewTotal').textContent,
          deposit: document.getElementById('previewDeposit').textContent
        }
      };
      
      // Collect items
      const products = formData.getAll('product[]');
      const specs = formData.getAll('specs[]');
      const quantities = formData.getAll('quantity[]');
      const costs = formData.getAll('cost[]');
      const totals = formData.getAll('total[]');
      
      for (let i = 0; i < products.length; i++) {
        if (products[i].trim()) {
          quoteData.items.push({
            product: products[i],
            specs: specs[i] || '',
            quantity: quantities[i] || '0',
            cost: costs[i] || '0',
            total: totals[i] || '0'
          });
        }
      }
      
      // Create preview window
      const previewWindow = window.open('', 'preview', 'width=800,height=600,scrollbars=yes');
      previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Quote Preview - ${quoteData.client.company}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
            .preview-container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .header { text-align: center; border-bottom: 2px solid #e3fc02; padding-bottom: 20px; margin-bottom: 30px; }
            .client-info { margin-bottom: 30px; }
            .items-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
            .items-table th, .items-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
            .items-table th { background: #f8f9fa; font-weight: 600; }
            .totals { text-align: right; }
            .totals .total-line { font-size: 18px; font-weight: bold; padding-top: 10px; border-top: 2px solid #333; }
          </style>
        </head>
        <body>
          <div class="preview-container">
            <div class="header">
              <h1>SHUREPRINT</h1>
              <p>Quote Preview</p>
            </div>
            
            <div class="client-info">
              <h3>Client Information</h3>
              <p><strong>Company:</strong> ${quoteData.client.company}</p>
              <p><strong>Contact:</strong> ${quoteData.client.contact}</p>
              <p><strong>Email:</strong> ${quoteData.client.email}</p>
              ${quoteData.client.phone ? `<p><strong>Phone:</strong> ${quoteData.client.phone}</p>` : ''}
            </div>
            
            <div class="items-section">
              <h3>Quote Items</h3>
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Specifications</th>
                    <th>Quantity</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${quoteData.items.map(item => `
                    <tr>
                      <td>${item.product}</td>
                      <td>${item.specs}</td>
                      <td>${item.quantity}</td>
                      <td>${item.total}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div class="totals">
              <p>Subtotal: ${quoteData.totals.subtotal}</p>
              <p>Shipping: ${quoteData.totals.shipping}</p>
              <p>Tax: ${quoteData.totals.tax}</p>
              <p class="total-line">Total: ${quoteData.totals.total}</p>
              <p><strong>Required Deposit: ${quoteData.totals.deposit}</strong></p>
            </div>
          </div>
        </body>
        </html>
      `);
      previewWindow.document.close();
    }

    // Initialize
    window.addEventListener('load', function(){
      updateProgress();
      calculateTotals();
      updatePreview();
      initializeProductCatalog();
      
      // Auto-load API data on page load with retry mechanism
      function attemptAPILoad(attempt = 1, maxAttempts = 5) {
        console.log(`üîÑ API Load Attempt ${attempt}/${maxAttempts}...`);
        console.log('API_CONFIG available:', !!window.API_CONFIG);
        console.log('loadTrelloLists function:', typeof window.loadTrelloLists);
        console.log('loadProductCatalogFromAirtable function:', typeof window.loadProductCatalogFromAirtable);
        
        // Check if functions are available
        const trelloAvailable = typeof window.loadTrelloLists === 'function';
        const airtableAvailable = typeof window.loadProductCatalogFromAirtable === 'function';
        
        if (!trelloAvailable || !airtableAvailable) {
          if (attempt < maxAttempts) {
            console.warn(`‚ö†Ô∏è API functions not ready, retrying in ${attempt * 500}ms...`);
            setTimeout(() => attemptAPILoad(attempt + 1, maxAttempts), attempt * 500);
            return;
          } else {
            console.error('‚ùå API functions never became available after', maxAttempts, 'attempts');
            showNotification('API functions failed to load. Check browser console.', 'error');
            return;
          }
        }
        
        // Functions are available, proceed with loading
        console.log('‚úÖ API functions ready, starting data load...');
        
        if (trelloAvailable) {
          console.log('üîÑ Auto-loading Trello lists...');
          window.loadTrelloLists().catch(err => {
            console.error('‚ùå Trello auto-load failed:', err);
            showNotification('Trello API failed to load', 'error');
          });
        }
        
        if (airtableAvailable) {
          console.log('üîÑ Auto-loading Airtable product catalog...');
          window.loadProductCatalogFromAirtable().catch(err => {
            console.error('‚ùå Airtable auto-load failed:', err);
            showNotification('Airtable API failed to load', 'error');
          });
        }
      }
      
      // Start the API loading process
      setTimeout(() => attemptAPILoad(), 1000);
      
      // Auto-save every 30 seconds
      autoSaveInterval = setInterval(autoSave, 30000);
      
      // Mark dirty on form changes
      document.getElementById('quoteForm').addEventListener('input', markDirty);
    });

    // Payment delegation functions
    function showPaymentOptions(paymentType) {
      const modal = document.getElementById('paymentOptionsModal');
      const typeText = paymentType === 'deposit' ? 'Deposit Payment' : 'Final Payment';
      document.getElementById('paymentTypeText').textContent = typeText;
      document.getElementById('paymentOptionsModal').dataset.paymentType = paymentType;
      modal.style.display = 'flex';
    }

    function closePaymentModal() {
      document.getElementById('paymentOptionsModal').style.display = 'none';
      document.getElementById('delegateEmailInput').value = '';
    }

    function processDirectPayment() {
      const paymentType = document.getElementById('paymentOptionsModal').dataset.paymentType;
      closePaymentModal();
      processPayment(paymentType);
    }

    async function processDelegatedPayment() {
      const paymentType = document.getElementById('paymentOptionsModal').dataset.paymentType;
      const delegateEmail = document.getElementById('delegateEmailInput').value.trim();
      
      if (!delegateEmail) {
        alert('Please enter an email address for the person who will make the payment.');
        return;
      }

      if (!validateEmail(delegateEmail)) {
        alert('Please enter a valid email address.');
        return;
      }

      try {
        const response = await fetch('/payments/delegate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            quoteId: window.currentQuoteId,
            paymentType,
            delegateEmail,
            customerEmail: document.getElementById('contactEmail').value
          }),
        });

        const result = await response.json();
        
        if (response.ok) {
          closePaymentModal();
          showNotification(`Payment request sent to ${delegateEmail}! Reminder emails will be sent until payment is completed.`);
        } else {
          throw new Error(result.error || 'Failed to send payment request');
        }
      } catch (error) {
        console.error('Error delegating payment:', error);
        alert('Failed to send payment request: ' + error.message);
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
  </script>

  <!-- Payment Options Modal -->
  <div id="paymentOptionsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: var(--shadow-lg);">
      <h3 style="margin-bottom: 20px; color: var(--text-primary);">
        <span id="paymentTypeText">Payment</span> Options
      </h3>
      
      <div style="margin-bottom: 25px;">
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          Who will be making this payment?
        </p>
        
        <button onclick="processDirectPayment()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
          üí≥ Customer Pays Now
          <small style="opacity: 0.8;">(Immediate payment)</small>
        </button>
        
        <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
          <h4 style="margin-bottom: 15px; color: var(--text-primary);">üìß Send to Someone Else</h4>
          <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
            Send payment request to another person (accounting, finance, etc.)
          </p>
          
          <div style="margin-bottom: 15px;">
            <label for="delegateEmailInput" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Payment Responsible Email:
            </label>
            <input 
              type="email" 
              id="delegateEmailInput" 
              placeholder="finance@company.com"
              style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;"
            />
          </div>
          
          <button onclick="processDelegatedPayment()" class="btn btn-accent" style="width: 100%;">
            üì§ Send Payment Request & Setup Reminders
          </button>
          
          <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 10px;">
            Both the customer and payment contact will receive reminder emails until payment is completed.
          </p>
        </div>
      </div>
      
      <button onclick="closePaymentModal()" class="btn btn-outline" style="width: 100%;">
        Cancel
      </button>
    </div>
  </div>
  <script src="/shared-navigation.js"></script>
</body>
</html>
